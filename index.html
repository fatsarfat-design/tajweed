<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Таджвид — учебное приложение</title>
<meta name="theme-color" content="#0b1220"/>
<link rel="manifest" href="manifest.webmanifest"/>
<style>
:root {
  --bg0:#050812; --bg1:#0b1220;
  --card: rgba(15, 27, 50, .72);
  --card2: rgba(10, 18, 34, .72);
  --text:#e8eefc; --muted: rgba(232,238,252,.72);
  --border: rgba(255,255,255,.10);
  --accent:#d4b26a;
  --shadow: 0 20px 70px rgba(0,0,0,.45);
  --radius: 22px;
  --base: 16px;
  --arabic: 22px;
  --arabic-font: "Noto Naskh Arabic","Amiri","Scheherazade New",Arial,sans-serif;
  --ui-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
}
html,body{height:100%}
body{
  margin:0; font-family:var(--ui-font); color:var(--text);
  background: radial-gradient(1000px 700px at 20% -10%, rgba(212,178,106,.15), transparent 55%),
            radial-gradient(900px 700px at 110% 10%, rgba(120,160,255,.18), transparent 55%),
            linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden; font-size:var(--base);
}
body.bg-stars::before{
  content:""; position:fixed; inset:0;
  background-image: radial-gradient(rgba(255,255,255,.08) 1px, transparent 1px);
  background-size: 28px 28px; opacity:.35; pointer-events:none;
}
body.bg-arabesque::before{
  content:""; position:fixed; inset:0;
  background-image:
    radial-gradient(rgba(212,178,106,.12) 1px, transparent 1px),
    radial-gradient(rgba(120,160,255,.10) 1px, transparent 1px);
  background-size: 22px 22px, 34px 34px;
  background-position: 0 0, 10px 16px;
  opacity:.35; pointer-events:none;
}
body.bg-paper{background: linear-gradient(180deg, #201a10, #0b1220);}
body.bg-paper::before{
  content:""; position:fixed; inset:0;
  background-image: radial-gradient(rgba(255,255,255,.06) 1px, transparent 1px);
  background-size: 20px 20px; opacity:.25; pointer-events:none;
}
.wrap{max-width:1150px;margin:0 auto;padding:28px 16px 70px;position:relative}
header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin:6px 0 18px}
.title h1{margin:0;font-size:26px;letter-spacing:.2px}
.title .sub{margin-top:6px;color:var(--muted);font-size:13px}
.top-right{display:flex;gap:10px;align-items:center}
.pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.20);box-shadow:0 10px 30px rgba(0,0,0,.25);font-variant-numeric:tabular-nums}
.btn{appearance:none;border:1px solid rgba(212,178,106,.45);background:rgba(212,178,106,.08);color:var(--text);padding:10px 14px;border-radius:999px;cursor:pointer;transition:transform .06s ease, background .2s ease}
.btn:hover{background:rgba(212,178,106,.14)}
.btn:active{transform:translateY(1px)}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin:16px 0}
.card{border:1px solid var(--border);background:linear-gradient(180deg,var(--card),var(--card2));border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden}
.card h2{margin:0 0 10px;font-size:20px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input,select{width:100%;background:rgba(0,0,0,.20);border:1px solid var(--border);border-radius:14px;padding:12px 12px;color:var(--text);outline:none}
select{cursor:pointer}
.hint{color:var(--muted);font-size:13px;margin-top:8px}
.toc{display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto;padding-right:6px}
.toc::-webkit-scrollbar{width:8px}
.toc::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:8px}
.toc-item{display:flex;gap:10px;align-items:flex-start;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.12);padding:12px;border-radius:16px;cursor:pointer;transition:background .2s ease,border-color .2s ease}
.toc-item:hover{background:rgba(0,0,0,.18);border-color:rgba(212,178,106,.25)}
.toc-item.active{border-color:rgba(212,178,106,.55);background:rgba(212,178,106,.10)}
.badge{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:28px;padding:0 10px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.20);font-size:12px;color:var(--muted);flex:0 0 auto}
.toc-meta{color:var(--muted);font-size:12px;margin-top:4px}
.lesson-head{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.nav .btn{padding:8px 12px;border-color:rgba(255,255,255,.18);background:rgba(0,0,0,.18)}
.nav .btn:hover{background:rgba(0,0,0,.24)}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.content{line-height:1.6}
.content h3{margin:16px 0 8px;font-size:16px}
.content ul{margin:8px 0 8px 18px}
.arabic{font-family:var(--arabic-font);font-size:var(--arabic);direction:rtl;unicode-bidi:plaintext}
.ex{border-left:3px solid rgba(212,178,106,.55);padding:10px 12px;margin:10px 0;background:rgba(0,0,0,.16);border-radius:14px}
.ex .label{color:var(--muted);font-size:12px;margin-bottom:6px}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);font-size:12px;color:var(--muted)}
.quiz{margin-top:14px;border:1px solid rgba(255,255,255,.10);border-radius:18px;background:rgba(0,0,0,.16);padding:14px}
.quiz h3{margin:0 0 8px}
.q{margin-top:10px;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;background:rgba(0,0,0,.12)}
.q .qtitle{margin:0 0 8px;font-weight:600}
.opts{display:grid;gap:8px}
.opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.10);cursor:pointer;user-select:none}
.opt:hover{border-color:rgba(212,178,106,.35)}
.opt input{margin-top:2px}
.quiz-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.msg{color:var(--muted);font-size:13px}
.msg.ok{color:rgba(61,220,151,.95)}
.msg.bad{color:rgba(255,90,107,.95)}
textarea{width:100%;min-height:120px;resize:vertical;background:rgba(0,0,0,.20);border:1px solid var(--border);border-radius:16px;padding:12px;color:var(--text);outline:none;font-family:var(--ui-font)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
.modal{width:min(860px,100%);max-height:85vh;overflow:auto;border-radius:24px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg, rgba(10,18,34,.96), rgba(5,8,18,.96));box-shadow:0 30px 90px rgba(0,0,0,.6);padding:18px;position:relative}
.modal h2{margin:0 0 10px}
.close{position:absolute;top:12px;right:12px;width:40px;height:40px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:var(--text);cursor:pointer}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:960px){.grid{grid-template-columns:1fr}.two{grid-template-columns:1fr}}
.small{font-size:13px;color:var(--muted)}
.file{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px}
</style>
</head>
<body class="bg-stars">
<div class="wrap">
<header>
  <div class="title">
    <h1>Таджвид — учебное приложение</h1>
    <div class="sub">Оглавление · примеры · схемы · тесты · экзамены · тренажёр · заметки</div>
  </div>
  <div class="top-right">
    <div class="pill"><span id="progress">0/0</span></div>
    <button class="btn" id="openSettings">Настройки</button>
  </div>
</header>

<div class="grid">
  <div class="card">
    <div class="two">
      <div>
        <div class="small">Поиск по урокам</div>
        <input class="input" id="q" placeholder="сыфаты, мадд, вакф..." autocomplete="off"/>
      </div>
      <div>
        <div class="small">Фильтр</div>
        <select id="filter">
          <option value="all">Все</option>
          <option value="b1">Блок 1: Махраджи</option>
          <option value="b2">Блок 2: Сыфаты</option>
          <option value="b3">Блок 3: Нун и тануин</option>
          <option value="b4">Блок 4: Мим с сукуном</option>
          <option value="b5">Блок 5: Мадды</option>
          <option value="b6">Блок 6: Вакф и ибтида</option>
          <option value="trainer">Тренажёр</option>
          <option value="exams">Экзамены</option>
        </select>
      </div>
    </div>
    <div class="hint">Подсказка: для перехода между темами в уроке используй кнопки <b>←</b>/<b>→</b> (или «Пред.»/«След.»).</div>
    <div class="hr"></div>
    <div class="toc" id="toc"></div>
  </div>

  <div class="card" id="lessonCard">
    <div class="lesson-head">
      <div><div class="kpi" id="lessonChips"></div></div>
      <div class="nav">
        <button class="btn" id="btnHome">Оглавление</button>
        <button class="btn" id="btnPrev">← Пред.</button>
        <button class="btn" id="btnNext">След. →</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="content" id="content"></div>

    <div class="hr"></div>
    <div>
      <h2 style="margin:0 0 10px; font-size:18px">Заметки</h2>
      <div class="small">Сохраняются на этом устройстве (браузер).</div>
      <div style="margin-top:10px">
        <textarea id="notes" placeholder="Пиши сюда свои заметки по теме…"></textarea>
        <div class="quiz-actions">
          <button class="btn" id="saveNotes">Сохранить</button>
          <button class="btn" id="clearNotes" style="border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.18);">Очистить</button>
          <span class="msg" id="notesMsg"></span>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="modal-backdrop" id="settingsBackdrop" aria-hidden="true">
  <div class="modal">
    <button class="close" id="closeSettings" title="Закрыть">✕</button>
    <h2>Настройки</h2>
    <div class="small">Настройки сохраняются на этом устройстве. Версия: <span class="file">v20</span></div>

    <div class="hr"></div>

    <div class="two">
      <div class="card" style="box-shadow:none">
        <h2 style="font-size:16px; margin:0 0 10px">Размер текста</h2>
        <div class="small">Основной размер: <span id="basePx"></span>px</div>
        <input type="range" id="baseRange" min="14" max="22" step="1"/>
        <div style="height:10px"></div>
        <div class="small">Арабский текст: <span id="arabicPx"></span>px</div>
        <input type="range" id="arabicRange" min="18" max="36" step="1"/>
      </div>

      <div class="card" style="box-shadow:none">
        <h2 style="font-size:16px; margin:0 0 10px">Шрифт арабского</h2>
        <div class="small">Выбирай тот, который лучше смотрится на твоём устройстве.</div>
        <div style="height:10px"></div>
        <select id="arabicFont">
          <option value='"Noto Naskh Arabic","Amiri","Scheherazade New",Arial,sans-serif'>Noto (рекоменд.)</option>
          <option value='"Amiri","Noto Naskh Arabic","Scheherazade New",Arial,sans-serif'>Amiri</option>
          <option value='"Scheherazade New","Noto Naskh Arabic","Amiri",Arial,sans-serif'>Scheherazade</option>
          <option value='Arial,sans-serif'>Arial (если других нет)</option>
        </select>
        <div class="hr"></div>
        <div class="arabic" style="margin-top:6px">ٱلْحَمْدُ لِلّٰهِ رَبِّ ٱلْعَالَمِينَ</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="two">
      <div class="card" style="box-shadow:none">
        <h2 style="font-size:16px; margin:0 0 10px">Фон и оформление</h2>
        <div class="small">Можно выбрать фон или поставить свою картинку.</div>
        <div style="height:10px"></div>
        <select id="bgMode">
          <option value="stars">Звёздный узор (по умолчанию)</option>
          <option value="arabesque">Арабески (узор)</option>
          <option value="paper">Тёплая бумага</option>
          <option value="custom">Своя картинка по ссылке</option>
        </select>
        <div style="height:10px"></div>
        <div class="small">Ссылка на картинку (https://...)</div>
        <input class="input" id="bgUrl" placeholder="https://example.com/my-background.jpg"/>
        <div class="hint">Совет: используй картинки без текста, чтобы не мешало чтению.</div>
      </div>

      <div class="card" style="box-shadow:none">
        <h2 style="font-size:16px; margin:0 0 10px">Заметки</h2>
        <div class="small">Экспорт/импорт заметок (если захочешь перенести на другое устройство).</div>
        <div class="quiz-actions" style="margin-top:12px">
          <button class="btn" id="exportNotes">Экспорт (JSON)</button>
          <button class="btn" id="importNotes">Импорт (JSON)</button>
          <button class="btn" id="clearAllNotes" style="border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.18);">Очистить все</button>
        </div>
        <div class="hint">Импорт попросит вставить текст JSON.</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="quiz-actions">
      <button class="btn" id="resetAll" style="border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.18);">Сбросить настройки</button>
      <span class="msg" id="settingsMsg"></span>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
const LESSONS = [
  {id:"home", block:"home", title:"Оглавление", tags:["Навигация"], html: `
    <h2>Оглавление</h2>
    <p>Это учебное приложение по таджвиду: темы → примеры → мини‑тесты → экзамен блока.</p>
    <div class="ex"><div class="label">Совет</div>
      <div>Начни с <b>Блок 1</b> (махраджи), затем <b>Блок 2</b> (сыфаты), потом правила <b>нун/тануина</b>, <b>мим</b>, <b>мадды</b>, и в конце <b>вакф и ибтида</b>.</div>
    </div>
    <p class="small">Если что-то пропало: «Настройки» → «Сбросить настройки» и обнови страницу (Ctrl+F5).</p>
  `, quiz:null},

  {id:"b1-1", block:"b1", title:"Махрадж — что это?", tags:["Блок 1","Основы"], html: `
    <h2>Махрадж — что это?</h2>
    <p><b>Махрадж</b> — место образования звука буквы (точка выхода).</p>
    <div class="ex"><div class="label">Запомнить</div>
      <ul>
        <li>Буква = <b>махрадж</b> (место) + <b>сыфаты</b> (качества)</li>
        <li>Если махрадж перепутан → буква становится другой</li>
      </ul>
    </div>
    <h3>Главные зоны махраджей</h3>
    <ul>
      <li>Горло (الحلق)</li>
      <li>Язык (اللسان)</li>
      <li>Губы (الشفتان)</li>
      <li>Носовая полость (الخيشوم) — для гунны</li>
    </ul>
  `, quiz:{title:"Мини‑тест", questions:[{q:"Махрадж — это…", options:["качество буквы","место образования звука","вид мадда","правило вакфа"], answer:1}] }},

  {id:"b1-2", block:"b1", title:"Горло: три отдела и буквы", tags:["Блок 1","Горло"], html: `
    <h2>Горло (الحلق)</h2>
    <p>Горло делится на 3 отдела. У каждого — свои буквы.</p>
    <div class="ex"><div class="label">Схема</div>
      <ul>
        <li><b>Самый верх</b> (ближе к рту): <span class="arabic">غ خ</span></li>
        <li><b>Средний</b>: <span class="arabic">ع ح</span></li>
        <li><b>Нижний</b> (ближе к груди): <span class="arabic">ء هـ</span></li>
      </ul>
    </div>
    <p class="small">Подсказка: тренируй пары: (غ/خ), (ع/ح), (ء/هـ).</p>
  `, quiz:{title:"Мини‑тест", questions:[{q:"Какие буквы относятся к среднему отделу горла?", options:["غ خ","ع ح","ء هـ","ف ب"], answer:1}] }},

  {id:"b1-3", block:"b1", title:"Носовая полость (الخيشوم) и гунна", tags:["Блок 1","Гунна"], html: `
    <h2>Носовая полость (الخيشوم)</h2>
    <p><b>الخيشوم</b> — место выхода <b>гунны</b> (носового звучания).</p>
    <div class="ex"><div class="label">Где встречается гунна</div>
      <ul>
        <li>При букве <span class="arabic">م</span> и <span class="arabic">ن</span> в некоторых правилах</li>
        <li>При <b>идгаме с гунной</b> и <b>ихфа</b></li>
      </ul>
    </div>
  `, quiz:{title:"Мини‑тест", questions:[{q:"Хайшум (الخيشوم) связан с…", options:["удлинением мадда","носовым звучанием (гунной)","местом ل","вакфом"], answer:1}] }},

  {id:"b2-1", block:"b2", title:"Сыфаты: что это и зачем", tags:["Блок 2","Основы"], html: `
    <h2>Сыфаты (صفات) — качества букв</h2>
    <p><b>Сыфаты</b> — это характеристики звука буквы. Они помогают произносить букву правильно и отличать похожие.</p>
    <div class="ex"><div class="label">Важно</div>
      <ul>
        <li>Махрадж отвечает за <b>место</b>, сыфаты — за <b>качество</b>.</li>
        <li>Сыфаты бывают <b>парные</b> и <b>непарные</b>.</li>
      </ul>
    </div>
  `, quiz:{title:"Мини‑тест", questions:[{q:"Сыфаты — это…", options:["место образования","качества произношения","знаки вакфа","виды сукуна"], answer:1}] }},

  {id:"b2-2", block:"b2", title:"Парные сыфаты (кратко)", tags:["Блок 2","Парные"], html: `
    <h2>Парные сыфаты (مختصرة)</h2>
    <p>Парные — это качества, у которых есть «пара‑противоположность».</p>
    <div class="ex"><div class="label">Пары (как в твоём учебнике)</div>
      <ul>
        <li><b>Щидда</b> (شدة) ↔ <b>Рахава</b> (رخاوة)</li>
        <li><b>Байния</b> (بينِيّة) — середина</li>
        <li><b>Хамс</b> (همس) ↔ <b>Джахр</b> (جهر)</li>
        <li><b>Истиля</b> (استعلاء) ↔ <b>Истефаль</b> (استفال)</li>
        <li><b>Итбак</b> (إطباق) ↔ <b>Инфитах</b> (انفتاح)</li>
        <li><b>Излякъ</b> (إذلاق) ↔ <b>Исмат</b> (إصمات)</li>
      </ul>
    </div>
  `, quiz:null},

  {id:"b2-3", block:"b2", title:"Непарные сыфаты", tags:["Блок 2","Непарные"], html: `
    <h2>Непарные сыфаты</h2>
    <p>Непарные — качества, у которых нет противоположной пары.</p>
    <div class="ex"><div class="label">Список (как ты написала)</div>
      <ul>
        <li><b>Сафир</b> (صفير)</li>
        <li><b>Калькаля</b> (قلقلة)</li>
        <li><b>Гъунна</b> (غنة)</li>
        <li><b>Такрир</b> (تكرير)</li>
        <li><b>Тафащщи</b> (تفشّي)</li>
        <li><b>Иститъаля</b> (استعلاء)</li>
        <li><b>Инхираф</b> (انحراف)</li>
      </ul>
    </div>
  `, quiz:null},

  {id:"b3-1", block:"b3", title:"Нун с сукуном и тануин: основа", tags:["Блок 3","Основы"], html: `
    <h2>Нун с сукуном и тануин</h2>
    <p>Правила чтения, когда встречается:</p>
    <ul>
      <li><span class="arabic">نْ</span> (нун с сукуном)</li>
      <li>три вида <b>тануина</b>: <span class="arabic">ً ٍ ٌ</span></li>
    </ul>
    <div class="ex"><div class="label">Термины</div>
      <p><b>Изхар</b>, <b>Идгъам</b>, <b>Икъляб</b>, <b>Ихфа</b>.</p>
    </div>
  `, quiz:{title:"Мини‑тест", questions:[{q:"Тануин — это…", options:["сукон на нун","двойные огласовки ً ٍ ٌ","мадд таби'и","буква хамза"], answer:1}] }},

  {id:"b3-2", block:"b3", title:"Изхар (إظهار)", tags:["Блок 3","Изхар"], html: `
    <h2>Изхар (إظهار)</h2>
    <p><b>Изхар</b> — ясное произношение нуна/тануина без слияния, если после них идут <b>буквы горла</b>.</p>
    <div class="ex"><div class="label">Буквы изхара</div>
      <div class="arabic">ء هـ ع ح غ خ</div>
    </div>
  `, quiz:null},

  {id:"b3-3", block:"b3", title:"Идгъам (إدغام): с гунной и без", tags:["Блок 3","Идгъам"], html: `
    <h2>Идгъам (إدغام)</h2>
    <p><b>Идгъам</b> — слияние нуна/тануина со следующей буквой.</p>
    <div class="ex"><div class="label">Буквы идгъама</div>
      <p><b>ي ر م ل و ن</b> (в слове <span class="arabic">يرملون</span>)</p>
      <ul>
        <li>С <b>гунной</b>: <span class="arabic">ي ن م و</span></li>
        <li>Без гунны: <span class="arabic">ل ر</span></li>
      </ul>
    </div>
  `, quiz:null},

  {id:"b3-4", block:"b3", title:"Икъляб (إقلاب)", tags:["Блок 3","Икъляб"], html: `
    <h2>Икъляб (إقلاب)</h2>
    <p>Если после нуна с сукуном или тануина идёт <span class="arabic">ب</span>, то нун превращается в «скрытый мим» с гунной.</p>
    <div class="ex"><div class="label">Ключ</div>
      <p><span class="arabic">نْ / تنوين + ب</span> → звучит как <span class="arabic">م</span> с гунной.</p>
    </div>
  `, quiz:null},

  {id:"b3-5", block:"b3", title:"Ихфа (إخفاء)", tags:["Блок 3","Ихфа"], html: `
    <h2>Ихфа (إخفاء)</h2>
    <p><b>Ихфа</b> — «скрывание»: звук между изхаром и идгъамом, с гунной.</p>
    <div class="ex"><div class="label">Дальше</div>
      <p>Мы добавим полный список букв ихфа и много примеров из учебника.</p>
    </div>
  `, quiz:null},

  {id:"b4-1", block:"b4", title:"Мим с сукуном (مْ): правила", tags:["Блок 4","Основы"], html: `
    <h2>Мим с сукуном (مْ)</h2>
    <p>Если встречается <span class="arabic">مْ</span>, правила зависят от следующей буквы (по учебнику добавим подробно).</p>
    <div class="ex"><div class="label">Важно</div>
      <p>Название правильное: <b>мим с сукуном</b>.</p>
    </div>
  `, quiz:null},

  {id:"b5-1", block:"b5", title:"Аль‑мадд (المدّ): виды удлинений", tags:["Блок 5","Мадды"], html: `
    <h2>Виды удлинений (المدّ)</h2>
    <p><b>Мадд</b> — удлинение звучания. Делится на:</p>
    <div class="ex"><div class="label">Две группы</div>
      <ul>
        <li><b>Мадд аслий</b> (основное удлинение)</li>
        <li><b>Мадд за’ид</b> (дополнительное удлинение)</li>
      </ul>
    </div>
    <h3>1) Мадд аслий</h3>
    <ul>
      <li><b>Мадд таби’и</b> — 2 хараката.</li>
      <li><b>Мадд бадал</b> — 2 хараката.</li>
      <li><b>Мадд ‘ивад</b> — 2 хараката.</li>
      <li><b>Мадд сила сугъра</b> — 2 хараката.</li>
    </ul>
    <h3>2) Мадд за’ид</h3>
    <p>Бывает по причине <b>хамзы</b> или <b>сукуна</b>.</p>
    <div class="ex"><div class="label">По причине хамзы</div>
      <ul>
        <li><b>Муттасыль</b> — 4–5 харакатов.</li>
        <li><b>Мунфасыль</b> — 2–4–5 харакатов.</li>
        <li><b>Сила кубра</b> — 4 хараката.</li>
      </ul>
    </div>
    <div class="ex"><div class="label">По причине сукуна</div>
      <ul>
        <li><b>Лязим</b> — 6 харакатов.</li>
        <li><b>‘Арид лиссукүн</b> — 2–4–6 харакатов.</li>
        <li><b>Лин</b> — 2–4–6 харакатов.</li>
      </ul>
    </div>
    <p class="small">Дальше добавим примеры из учебника и картинки/схемы.</p>
  `, quiz:{title:"Мини‑тест (Мадды)", questions:[
    {q:"Сколько харакатов у мадд таби’и?", options:["2","4–5","6","2–4–6"], answer:0},
    {q:"Мадд муттасыль — это когда хамза…", options:["в следующем слове","в одном слове после мадда","до мадда","не важна"], answer:1}
  ]}},

  {id:"b6-1", block:"b6", title:"Вакф и ибтида: смысл", tags:["Блок 6","Вакф"], html: `
    <h2>Вакф и ибтида</h2>
    <p><b>Вакф</b> — остановка, <b>ибтида</b> — начало/возобновление.</p>
    <div class="ex"><div class="label">Значки в Коране</div>
      <p>Тему «значки в Коране» добавим подробно по учебнику: значения и примеры.</p>
    </div>
  `, quiz:null},

  {id:"trainer-1", block:"trainer", title:"Тренажёр (в разработке)", tags:["Тренажёр"], html:`<h2>Тренажёр</h2><p>Здесь будет практика: выбор правила по примеру и быстрые проверки.</p>`, quiz:null},
  {id:"exams-1", block:"exams", title:"Экзамены (в разработке)", tags:["Экзамены"], html:`<h2>Экзамены</h2><p>В конце каждого блока будет экзамен.</p>`, quiz:null},
];

// ===== STATE =====
const KEY = "tajweed_app_state_v20";
const NOTES_KEY = "tajweed_notes_v20";
const SETTINGS_KEY = "tajweed_settings_v20";

const defaultSettings = {
  base:16, arabic:22,
  arabicFont:'"Noto Naskh Arabic","Amiri","Scheherazade New",Arial,sans-serif',
  bgMode:"stars", bgUrl:""
};

function loadSettings(){
  try{ const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||"null"); return {...defaultSettings, ...(s||{})}; }
  catch(e){ return {...defaultSettings}; }
}
function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
let settings = loadSettings();

function applySettings(){
  document.documentElement.style.setProperty("--base", settings.base+"px");
  document.documentElement.style.setProperty("--arabic", settings.arabic+"px");
  document.documentElement.style.setProperty("--arabic-font", settings.arabicFont);

  document.body.classList.remove("bg-stars","bg-arabesque","bg-paper");
  document.body.style.backgroundImage = "";
  if(settings.bgMode==="stars") document.body.classList.add("bg-stars");
  if(settings.bgMode==="arabesque") document.body.classList.add("bg-arabesque");
  if(settings.bgMode==="paper") document.body.classList.add("bg-paper");
  if(settings.bgMode==="custom" && settings.bgUrl){
    document.body.style.backgroundImage = "linear-gradient(180deg, rgba(5,8,18,.86), rgba(11,18,32,.92)), url('"+settings.bgUrl+"')";
    document.body.style.backgroundSize="cover";
    document.body.style.backgroundPosition="center";
    document.body.style.backgroundAttachment="fixed";
  }
}

function loadState(){
  try{
    return JSON.parse(localStorage.getItem(KEY)||"null") || {currentId:"home", completed:{}};
  }catch(e){ return {currentId:"home", completed:{}}; }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
let state = loadState();

function loadNotesMap(){
  try{ return JSON.parse(localStorage.getItem(NOTES_KEY)||"null") || {}; }
  catch(e){ return {}; }
}
function saveNotesMap(m){ localStorage.setItem(NOTES_KEY, JSON.stringify(m)); }
let notesMap = loadNotesMap();

// ===== UI =====
const $ = (s)=>document.querySelector(s);
const tocEl = $("#toc");
const contentEl = $("#content");
const chipsEl = $("#lessonChips");
const qEl = $("#q");
const filterEl = $("#filter");
const progressEl = $("#progress");
const notesEl = $("#notes");
const notesMsg = $("#notesMsg");

function stripHtml(s){
  const tmp = document.createElement("div");
  tmp.innerHTML = s;
  return tmp.textContent || tmp.innerText || "";
}
function blockLabel(b){
  return ({home:"Оглавление", b1:"Блок 1", b2:"Блок 2", b3:"Блок 3", b4:"Блок 4", b5:"Блок 5", b6:"Блок 6", trainer:"Тренажёр", exams:"Экзамены"})[b] || b;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[m]);
}
function getVisibleLessons(){
  const query = (qEl.value||"").trim().toLowerCase();
  const f = filterEl.value;
  return LESSONS.filter((l)=>{
    if(f!=="all" && l.block!==f) return false;
    if(!query) return true;
    const hay = (l.title+" "+(l.tags||[]).join(" ")+" "+stripHtml(l.html)).toLowerCase();
    return hay.includes(query);
  });
}
function renderToc(){
  const items = getVisibleLessons();
  tocEl.innerHTML="";
  if(items.length===0){
    tocEl.innerHTML = '<div class="msg bad">Ничего не найдено. Убери фильтр или очисти поиск.</div>';
    return;
  }
  for(const l of items){
    const div = document.createElement("div");
    div.className = "toc-item"+(l.id===state.currentId?" active":"");
    const done = !!state.completed[l.id];
    div.innerHTML = `
      <div class="badge">${done ? "✓" : "•"}</div>
      <div style="min-width:0">
        <div style="font-weight:600">${escapeHtml(l.title)}</div>
        <div class="toc-meta">${escapeHtml(blockLabel(l.block))}${(l.tags&&l.tags.length) ? " · "+escapeHtml(l.tags.join(" · ")) : ""}</div>
      </div>
    `;
    div.onclick = ()=>openLesson(l.id);
    tocEl.appendChild(div);
  }
}
function setProgress(){
  const total = LESSONS.length - 1;
  const done = Object.keys(state.completed).filter((k)=>k!=="home").length;
  progressEl.textContent = done + "/" + total;
}
function renderQuiz(lesson){
  if(!lesson.quiz) return "";
  const qz = lesson.quiz;
  let out = `<div class="quiz"><h3>${escapeHtml(qz.title||"Тест")}</h3><div class="msg">Проверь себя прямо сейчас.</div>`;
  qz.questions.forEach((qq,i)=>{
    out += `<div class="q" data-q="${i}">
      <div class="qtitle">${escapeHtml(qq.q)}</div>
      <div class="opts">`;
    qq.options.forEach((opt,oi)=>{
      out += `<label class="opt"><input type="radio" name="q_${lesson.id}_${i}" value="${oi}"/><div>${escapeHtml(opt)}</div></label>`;
    });
    out += `</div></div>`;
  });
  out += `<div class="quiz-actions">
    <button class="btn" onclick="checkQuiz('${lesson.id}')">Проверить</button>
    <button class="btn" style="border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.18);" onclick="resetQuiz('${lesson.id}')">Сбросить</button>
    <span class="msg" id="quizMsg"></span>
  </div></div>`;
  return out;
}
window.checkQuiz = function(lessonId){
  const lesson = LESSONS.find((l)=>l.id===lessonId);
  if(!lesson || !lesson.quiz) return;
  const msg = document.getElementById("quizMsg");
  let ok=0;
  lesson.quiz.questions.forEach((qq,i)=>{
    const sel = document.querySelector(`input[name="q_${lessonId}_${i}"]:checked`);
    if(sel && Number(sel.value)===qq.answer) ok++;
  });
  const total = lesson.quiz.questions.length;
  if(ok===total){ msg.textContent = "✅ Отлично! "+ok+"/"+total; msg.className="msg ok"; }
  else { msg.textContent = "❗ Пока так: "+ok+"/"+total+". Попробуй ещё раз."; msg.className="msg bad"; }
}
window.resetQuiz = function(lessonId){
  const lesson = LESSONS.find((l)=>l.id===lessonId);
  if(!lesson || !lesson.quiz) return;
  lesson.quiz.questions.forEach((qq,i)=>{
    document.querySelectorAll(`input[name="q_${lessonId}_${i}"]`).forEach((x)=>x.checked=false);
  });
  const msg = document.getElementById("quizMsg");
  if(msg){ msg.textContent=""; msg.className="msg"; }
}

function openLesson(id){
  const idx = LESSONS.findIndex((x)=>x.id===id);
  if(idx<0) return;
  state.currentId=id; saveState(); renderToc();

  const l = LESSONS[idx];
  chipsEl.innerHTML="";
  const chips = [blockLabel(l.block), ...(l.tags||[])].slice(0,6);
  chips.forEach((c)=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=c; chipsEl.appendChild(s); });

  contentEl.innerHTML = l.html + renderQuiz(l);

  notesEl.value = notesMap[id] || "";
  notesMsg.textContent="";

  if(id!=="home"){ state.completed[id]=true; saveState(); setProgress(); renderToc(); }
}
function navTo(delta){
  const items = getVisibleLessons();
  const idx = items.findIndex((x)=>x.id===state.currentId);
  if(idx<0) return;
  const next = items[idx+delta];
  if(next) openLesson(next.id);
}

// notes buttons
$("#saveNotes").onclick = ()=>{
  notesMap[state.currentId]=notesEl.value||"";
  saveNotesMap(notesMap);
  notesMsg.textContent="Сохранено"; notesMsg.className="msg ok";
  setTimeout(()=>{notesMsg.textContent=""; notesMsg.className="msg";}, 1200);
};
$("#clearNotes").onclick = ()=>{
  notesEl.value=""; notesMap[state.currentId]=""; saveNotesMap(notesMap);
  notesMsg.textContent="Очищено"; notesMsg.className="msg";
  setTimeout(()=>{notesMsg.textContent="";}, 900);
};

// settings modal
const backdrop = $("#settingsBackdrop");
const settingsMsg = $("#settingsMsg");
function syncSettingsUI(){
  $("#baseRange").value = settings.base;
  $("#arabicRange").value = settings.arabic;
  $("#basePx").textContent = settings.base;
  $("#arabicPx").textContent = settings.arabic;
  $("#arabicFont").value = settings.arabicFont;
  $("#bgMode").value = settings.bgMode;
  $("#bgUrl").value = settings.bgUrl || "";
}
function openSettings(){ backdrop.style.display="flex"; backdrop.setAttribute("aria-hidden","false"); syncSettingsUI(); }
function closeSettings(){ backdrop.style.display="none"; backdrop.setAttribute("aria-hidden","true"); settingsMsg.textContent=""; }
$("#openSettings").onclick = openSettings;
$("#closeSettings").onclick = closeSettings;
backdrop.addEventListener("click",(e)=>{ if(e.target===backdrop) closeSettings(); });

$("#baseRange").addEventListener("input",(e)=>{ settings.base=Number(e.target.value); $("#basePx").textContent=settings.base; saveSettings(settings); applySettings(); });
$("#arabicRange").addEventListener("input",(e)=>{ settings.arabic=Number(e.target.value); $("#arabicPx").textContent=settings.arabic; saveSettings(settings); applySettings(); });
$("#arabicFont").addEventListener("change",(e)=>{ settings.arabicFont=e.target.value; saveSettings(settings); applySettings(); });
$("#bgMode").addEventListener("change",(e)=>{ settings.bgMode=e.target.value; saveSettings(settings); applySettings(); });
$("#bgUrl").addEventListener("change",(e)=>{ settings.bgUrl=e.target.value.trim(); saveSettings(settings); applySettings(); });

$("#resetAll").onclick = ()=>{
  settings = {...defaultSettings};
  saveSettings(settings); applySettings(); syncSettingsUI();
  settingsMsg.textContent="Сброшено"; settingsMsg.className="msg ok";
  setTimeout(()=>{settingsMsg.textContent=""; settingsMsg.className="msg";}, 1200);
};

$("#exportNotes").onclick = ()=>{
  const data = JSON.stringify(notesMap, null, 2);
  (navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(data) : Promise.reject())
    .then(()=>{ settingsMsg.textContent="JSON заметок скопирован в буфер"; settingsMsg.className="msg ok"; setTimeout(()=>{settingsMsg.textContent="";},1500); })
    .catch(()=>{ prompt("Скопируй этот JSON:", data); });
};
$("#importNotes").onclick = ()=>{
  const txt = prompt("Вставь JSON заметок:");
  if(!txt) return;
  try{
    const obj = JSON.parse(txt);
    if(typeof obj!=="object" || obj===null) throw new Error("bad");
    notesMap=obj; saveNotesMap(notesMap); openLesson(state.currentId);
    settingsMsg.textContent="Импортировано"; settingsMsg.className="msg ok";
    setTimeout(()=>{settingsMsg.textContent="";},1200);
  }catch(e){
    alert("Не удалось импортировать: проверь JSON.");
  }
};
$("#clearAllNotes").onclick = ()=>{
  if(!confirm("Удалить все заметки на этом устройстве?")) return;
  notesMap={}; saveNotesMap(notesMap); openLesson(state.currentId);
  settingsMsg.textContent="Все заметки очищены"; settingsMsg.className="msg";
  setTimeout(()=>{settingsMsg.textContent="";},1200);
};

// top nav
$("#btnHome").onclick = ()=>openLesson("home");
$("#btnPrev").onclick = ()=>navTo(-1);
$("#btnNext").onclick = ()=>navTo(+1);

// search/filter
qEl.addEventListener("input", renderToc);
filterEl.addEventListener("change", renderToc);

// init
applySettings();
setProgress();
renderToc();
openLesson(state.currentId || "home");

// PWA
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
}
</script>
</body>
</html>
