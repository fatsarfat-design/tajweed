<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Таджвид — учебное приложение</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b1220"/>
<style>
:root{
  color-scheme:dark;
  --bg:#070b14;
  --panel:#0f1a2f;
  --panel2:#0b1220;
  --border:#243042;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --gold:#d6b25e;
  --accent:#3b82f6;
  --radius:18px;
  --fs:16px;
  --arabic-size:1.25em;
  --arabic-font:"Amiri","Scheherazade New","Noto Naskh Arabic","Noto Sans Arabic","Arial";
  --ui-font:system-ui,Segoe UI,Roboto,Arial;
}
html,body{height:100%}
body{
  margin:0;
  font:var(--fs)/1.6 var(--ui-font);
  background:
    radial-gradient(900px 600px at 20% -10%, rgba(214,178,94,.18), transparent 60%),
    radial-gradient(900px 600px at 90% 10%, rgba(59,130,246,.14), transparent 55%),
    radial-gradient(800px 700px at 40% 120%, rgba(214,178,94,.10), transparent 60%),
    var(--bg);
  color:var(--text);
}
/* subtle arabesque pattern */
body:before{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  opacity:.08;
  background-image:
    radial-gradient(circle at 25px 25px, rgba(214,178,94,.9) 2px, transparent 3px),
    radial-gradient(circle at 75px 75px, rgba(214,178,94,.7) 1.5px, transparent 3px);
  background-size:100px 100px;
  mix-blend-mode:screen;
}
header{
  position:sticky; top:0; z-index:10;
  background:rgba(7,11,20,.86);
  backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(36,48,66,.85);
}
.wrap{max-width:1080px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{margin:0;font-size:20px;letter-spacing:.2px}
h2,h3{margin:0 0 10px}
.muted{color:var(--muted)}
.small{font-size:12px}
.right{margin-left:auto}
.pill{padding:5px 12px;border:1px solid var(--border);border-radius:999px;background:rgba(15,26,47,.35)}
.card{
  background:linear-gradient(180deg, rgba(15,26,47,.92), rgba(11,18,32,.92));
  border:1px solid rgba(36,48,66,.9);
  border-radius:var(--radius);
  padding:14px;
  margin:12px 0;
  box-shadow:0 14px 30px rgba(0,0,0,.22);
}
.hr{height:1px;background:rgba(36,48,66,.9);margin:12px 0}
button{
  border:1px solid rgba(43,58,82,.95);
  background:rgba(17,28,51,.85);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  cursor:pointer;
}
button.primary{background:rgba(31,42,68,.9);border-color:rgba(59,130,246,.65)}
button.gold{background:rgba(214,178,94,.12);border-color:rgba(214,178,94,.55)}
button.ghost{background:transparent}
input,select{
  width:100%; box-sizing:border-box;
  border:1px solid rgba(36,48,66,.95);
  background:rgba(11,18,32,.85);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.list{display:grid;gap:10px}
.tag{
  display:inline-block;
  font-size:12px;
  color:#d1d5db;
  border:1px solid rgba(36,48,66,.95);
  border-radius:999px;
  padding:3px 10px;
  margin-right:6px;
  margin-top:6px;
  background:rgba(11,18,32,.65);
}
/* Diagrams */
.diagram{
  background:rgba(11,18,32,.8);
  border:1px solid rgba(36,48,66,.95);
  border-radius:16px;
  padding:12px;
  margin:10px 0;
}
.diagram .title{font-weight:900;margin-bottom:8px;color:#f3f4f6}
.flow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.box{
  background:rgba(17,28,51,.9);
  border:1px solid rgba(36,48,66,.95);
  border-radius:14px;
  padding:10px 12px;
  min-width:200px;
}
.arrow{opacity:.85;color:rgba(214,178,94,.9)}
/* Arabic examples */
.ar{
  font-family:var(--arabic-font);
  font-size:var(--arabic-size);
  direction:rtl;
  unicode-bidi:isolate;
  letter-spacing:.2px;
}
.arline{
  padding:10px 12px;
  border:1px dashed rgba(214,178,94,.45);
  border-radius:14px;
  background:rgba(214,178,94,.06);
  margin:8px 0;
}
.hl{
  color:rgba(214,178,94,1);
  font-weight:900;
  text-shadow:0 0 14px rgba(214,178,94,.25);
}
/* Quiz */
.q{
  background:rgba(11,18,32,.85);
  border:1px solid rgba(36,48,66,.95);
  border-radius:16px;
  padding:12px;
  margin:10px 0;
}
.opt{display:flex;align-items:center;gap:10px;margin:8px 0}
.opt input{transform:scale(1.15)}
.good{color:#34d399}
.bad{color:#fb7185}
.notice{padding:10px 12px;border-radius:14px;border:1px solid rgba(36,48,66,.95);background:rgba(11,18,32,.85)}
kbd{border:1px solid rgba(36,48,66,.95);border-bottom-width:2px;border-radius:8px;padding:2px 7px;background:rgba(11,18,32,.75);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;font-size:12px}
/* Settings drawer */
#settingsDrawer{
  position:fixed; top:0; right:0; height:100%; width:min(420px, 92vw);
  transform:translateX(105%);
  transition:transform .22s ease;
  z-index:50;
  background:rgba(7,11,20,.92);
  border-left:1px solid rgba(36,48,66,.95);
  backdrop-filter: blur(12px);
}
#settingsDrawer.open{transform:translateX(0)}
</style>
</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div>
      <h1>Таджвид — учебное приложение</h1>
      <div class="muted small">Оглавление · примеры · схемы · тесты · экзамены · тренажёр</div>
    </div>
    <div class="row">
      <span class="pill" id="progressPill">0/0</span>
      <button class="gold" id="settingsBtn">Настройки</button>
      <button id="installBtn" class="primary" style="display:none">Установить</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="viewHome">
    <div class="card">
      <div class="grid2">
        <div>
          <div class="muted small">Поиск по урокам</div>
          <input id="q" placeholder="сыфаты, شدة, мадд, вакф…" />
        </div>
        <div>
          <div class="muted small">Фильтр</div>
          <select id="blockFilter">
            <option value="all">Все</option>
            <option value="b1">Блок 1: Махраджи</option>
            <option value="b2">Блок 2: Сыфаты</option>
            <option value="b3">Блок 3: Нун ساкина</option>
            <option value="b4">Блок 4: Мим ساкина</option>
            <option value="b5">Блок 5: Мадды</option>
            <option value="b6">Блок 6: Вакф и ибтида</option>
            <option value="trainer">Тренажёр</option>
            <option value="exam">Экзамены</option>
          </select>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted small">
        Подсказка: для перехода между темами в уроке используй кнопки <kbd>←</kbd> / <kbd>→</kbd> (или «Пред.» / «След.»).
      </div>
    </div>

    <div class="card">
      <h2>Оглавление</h2>
      <div class="muted">Сейчас мы обновили Блок 2 (Сыфаты): правильная терминология + арабские примеры + подробнее.</div>
      <div class="hr"></div>
      <div id="lessonList" class="list"></div>
    </div>
  </div>

  <div id="viewLesson" style="display:none">
    <div class="card">
      <div class="row">
        <button onclick="goHome()">← Оглавление</button>
        <button class="ghost" id="prevBtn">← Пред.</button>
        <button class="ghost" id="nextBtn">След. →</button>
        <span class="right"></span>
        <button id="btnDone" class="primary"></button>
      </div>
    </div>

    <div class="card">
      <h2 id="lessonTitle"></h2>
      <div class="muted small" id="lessonBadges"></div>
      <div class="hr"></div>
      <div id="lessonText" style="white-space:pre-wrap"></div>
      <div id="lessonExtras"></div>
      <div id="lessonDiagram"></div>
    </div>

    <div class="card" id="quizBlock" style="display:none"></div>
  </div>
</main>

<!-- Settings Drawer -->
<div id="settingsDrawer">
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Настройки</h2>
      <button class="ghost" id="closeSettings">✕</button>
    </div>
    <div class="muted small">Настройки сохраняются на этом устройстве.</div>
    <div class="hr"></div>

    <div class="card" style="margin:0 0 12px 0">
      <h3>Размер текста</h3>
      <div class="muted small">Основной размер</div>
      <input id="fsRange" type="range" min="14" max="22" step="1"/>
      <div class="muted small">Текущий: <span id="fsVal"></span> px</div>
      <div class="hr"></div>
      <div class="muted small">Размер арабского текста</div>
      <input id="arRange" type="range" min="1.05" max="1.85" step="0.05"/>
      <div class="muted small">Текущий: <span id="arVal"></span></div>
    </div>

    <div class="card" style="margin:0 0 12px 0">
      <h3>Шрифт арабского</h3>
      <div class="muted small">Выбирай тот, который лучше смотрится на твоём устройстве</div>
      <select id="arFontSel">
        <option value='"Amiri","Scheherazade New","Noto Naskh Arabic","Noto Sans Arabic","Arial"'>Amiri / Scheherazade / Noto (рекоменд.)</option>
        <option value='"Noto Naskh Arabic","Noto Sans Arabic","Arial"'>Noto Naskh Arabic</option>
        <option value='"Scheherazade New","Noto Naskh Arabic","Arial"'>Scheherazade New</option>
        <option value='"Arial"'>Arial (если других нет)</option>
      </select>
    </div>

    <div class="card" style="margin:0">
      <h3>Быстрые кнопки</h3>
      <div class="row">
        <button class="primary" id="resetSettings">Сбросить настройки</button>
      </div>
    </div>
  </div>
</div>

<script>
// ==========================
// Content
// ==========================
const lessons = [// -------- Блок 1 (сжато — как раньше)
  {id:"b1_intro", block:"b1", order:1, title:"Б1-1) Махрадж — что это", tags:["махрадж"],
   text:`Махрадж — место образования звука.\n\nЗоны:\n— горло\n— язык\n— губы\n— нос (гъунна)\n\nМахрадж отвечает «ГДЕ», сыфат отвечает «КАК».`,
   quiz:[{q:"Махрадж — это…",a:["качество буквы","место образования","вид мадда"],c:1}]
  },

  // -------- Блок 2 (обновлён, подробно + примеры)
  {id:"b2_intro", block:"b2", order:10, title:"Б2-1) Сыфаты (صفات الحروف): зачем нужны", tags:["сыфаты","صفات"],
   text:`СЫФАТЫ (صفات الحروف) — это качества букв, которые придают звуку правильное, специфическое звучание.\n\nЗачем нужны сыфаты:\n1) чтобы буква звучала полноценно (твёрдо/мягко, со свистом/без, с носовым оттенком и т.д.)\n2) чтобы отличать буквы даже в одном махрадже\n\nВажно:\n— махрадж и сыфат взаимосвязаны\n— одна буква может иметь сразу несколько сифатов`,
   extras:[
     {type:"callout", title:"Запомни формулу", body:"Махрадж = ГДЕ. Сыфат = КАК. Вместе дают правильную букву."}
   ],
   diagram:{title:"Схема: как работать с буквой", steps:[
     {t:"1) Найди махрадж", d:"место выхода буквы"},
     {t:"2) Наложи сыфаты", d:"качества (твёрдость, свист, дыхание…)"},
     {t:"3) Проверь слухом", d:"звучит ли буква “как надо”"}
   ]},
   quiz:[{q:"Сыфаты — это…",a:["место выхода буквы","качества звука","знаки вакфа"],c:1}]
  },

  {id:"b2_1", block:"b2", order:11, title:"Б2-2) Щидда · Байния · Рахава (الشِّدَّة · البَيْنِيَّة · الرِّخَاوَة)", tags:["щидда","байния","рахава","شدة","رخاوة"],
   text:`Это группа сифатов по “силе удержания” звука.\n\n✅ Щидда (الشِّدَّة): звук удерживается полностью (как “взрыв”).\n✅ Рахава (الرِّخَاوَة): звук свободно течёт (можно тянуть).\n✅ Байния (البَيْنِيَّة): промежуточное состояние.\n\nБуквы:\n— Щидда: أ ج د ق ط ب ك ت\n— Байния: ل ن ع م ر\n— Рахава: остальные (в классике: ف ث ذ س ش ص ز ظ خ غ ح ه и др.)\n\nПрактика:\n— в щидде не “тяни” букву\n— в рахаве не “обрывай” слишком резко\n— в байнии держи баланс`,
   extras:[
     {type:"arabic_examples", title:"Примеры (слова)", items:[
       {ar:"أَ<span class='hl'>تَ</span>ى", note:"Щидда: звук резкий"},
       {ar:"سَ<span class='hl'>بِ</span>يل", note:"Рахава: звук течёт (с/свист и тянущееся звучание)"},
       {ar:"<span class='hl'>رَ</span>بِّ", note:"Байния: не взрыв, не протяжение — середина"}
     ]}
   ],
   diagram:{title:"Схема: поток звука", steps:[
     {t:"Щидда", d:"закрыто → резко"},
     {t:"Байния", d:"средне"},
     {t:"Рахава", d:"открыто → течёт"}
   ]},
   quiz:[
     {q:"К байнии относятся…", a:["ل ن ع م ر","أ ج د ق ط ب ك ت","ف ح ث ه ش خ"], c:0},
     {q:"Щидда — это…", a:["свободное течение","полное удержание","носовой призвук"], c:1}
   ]
  },

  {id:"b2_2", block:"b2", order:12, title:"Б2-3) Джахр · Хамс (الجَهْر · الهَمْس)", tags:["джахр","хамс"],
   text:`Хамс (الهَمْس) — дыхание/воздух при произношении (голосовые связки “не включились”).\nДжахр (الجَهْر) — воздух удержан, звук “звонче”.\n\nБуквы хамса:\nف ح ث ه ش خ ص س ك ت\n(запоминалка: فَحَثَّهُ شَخْصٌ سَكَتَ)\n\nВсе остальные буквы — джахр.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"<span class='hl'>س</span>َمَاء", note:"Хамс: слышно “дыхание”"},
       {ar:"<span class='hl'>ب</span>َصِير", note:"Джахр: воздух удержан (звонче)"}
     ]}
   ],
   diagram:{title:"Схема: хамс/джахр", steps:[
     {t:"Если слышно дыхание", d:"→ ХАМС"},
     {t:"Иначе", d:"→ ДЖАХР"}
   ]},
   quiz:[{q:"С относится к…", a:["джахр","хамс"], c:1}]
  },

  {id:"b2_3", block:"b2", order:13, title:"Б2-4) Исти‘ля · Истифаль (الاِسْتِعْلَاء · الاِسْتِفَال)", tags:["истиля","истифаль","твёрдость"],
   text:`Исти‘ля (الاِسْتِعْلَاء) — подъём задней части языка → твёрдость.\nИстифаль (الاِسْتِفَال) — отсутствие подъёма → мягкость.\n\nБуквы исти‘ля:\nخ ص ض غ ط ق ظ\n\nСовет: почувствуй “ширину/тяжесть” звука при исти‘ля.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"<span class='hl'>ق</span>َالَ", note:"Исти‘ля: твёрдый звук"},
       {ar:"<span class='hl'>ص</span>ِرَاط", note:"Исти‘ля + (часто) другие сыфаты"}
     ]}
   ],
   diagram:{title:"Схема: твёрдость", steps:[
     {t:"Буква из группы", d:"خ ص ض غ ط ق ظ"},
     {t:"→", d:"Исти‘ля (твёрдо)"},
     {t:"иначе", d:"Истифаль (мягче)"}
   ]},
   quiz:[{q:"ق — это…", a:["истифаль","истиля"], c:1}]
  },

  {id:"b2_4", block:"b2", order:14, title:"Б2-5) Итбак · Инфитах (الإِطْبَاق · الاِنْفِتَاح)", tags:["итбак","инфитах"],
   text:`Итбак (الإِطْبَاق) — усиление твёрдости (как “сжатие”).\nИнфитах (الاِنْفِتَاح) — раскрытие.\n\nБуквы итбака:\nص ض ط ظ\n\nИтбак — это “топ-уровень твёрдости”: их важно читать осознанно.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"<span class='hl'>ط</span>َالَ", note:"Итбак: особо твёрдо"},
       {ar:"<span class='hl'>ص</span>َبْر", note:"Итбак на ص"}
     ]}
   ],
   diagram:{title:"Схема: итбак", steps:[
     {t:"Если буква", d:"ص ض ط ظ"},
     {t:"→", d:"ИТБАК"},
     {t:"иначе", d:"ИНФИТАХ"}
   ]},
   quiz:[{q:"Буквы итбака:", a:["ص ض ط ظ","خ ص ض غ ط ق ظ","س ص ز"], c:0}]
  },

  {id:"b2_5", block:"b2", order:15, title:"Б2-6) Калькаля (القَلْقَلَة)", tags:["калькаля"],
   text:`Калькаля (القَلْقَلَة) — лёгкий “отскок” звука.\n\nБуквы калькаля:\nق ط ب ج د\n\nВажно:\n— это не добавление гласной\n— это лёгкое оживление согласного, особенно при сукуне`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"أَحَ<span class='hl'>دْ</span>", note:"Калькаля на دْ"},
       {ar:"يَقْ<span class='hl'>طَ</span>عُ", note:"Калькаля проявляется по-разному, но принцип один"}
     ]}
   ],
   diagram:{title:"Схема: калькаля", steps:[
     {t:"Если буква", d:"ق ط ب ج د"},
     {t:"и есть сукун/остановка", d:"проявляется сильнее"},
     {t:"→", d:"лёгкий отскок"}
   ]},
   quiz:[{q:"Калькаля на…", a:["ق ط ب ج د","س ص ز","ء ه ع"], c:0}]
  },

  {id:"b2_6", block:"b2", order:16, title:"Б2-7) Сафир · Лейн · Такрир · Инхираф", tags:["сафир","лейн","такрир","инхираф"],
   text:`Непарные (дополнительные) сифаты:\n\n1) Сафир (الصَّفِير) — “свист”: س ص ز\n2) Лейн (اللِّين) — мягкость на و/ي после фатхи (خَوْف / بَيْت)\n3) Такрир (التَّكْرِير) — только у ر (осторожно: не “дробить” звук)\n4) Инхираф (الاِنْحِرَاف) — у ل и ر (смещение)\n\nСовет: эти сифаты нужно “накладывать” осознанно (например, свист у س).`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"<span class='hl'>س</span>َبِيل", note:"Сафир на س"},
       {ar:"خَ<span class='hl'>وْ</span>ف", note:"Лейн на وْ после фатхи"},
       {ar:"بَ<span class='hl'>يْ</span>ت", note:"Лейн на يْ после фатхи"},
       {ar:"<span class='hl'>ر</span>َبِّ", note:"Такрир — не переборщить"}
     ]}
   ],
   diagram:{title:"Схема: дополнительные сифаты", steps:[
     {t:"Сафир", d:"س ص ز"},
     {t:"Лейн", d:"و/ي после фатхи"},
     {t:"Такрир", d:"ر (контролировать)"},
     {t:"Инхираф", d:"ل ر"}
   ]},
   quiz:[{q:"Сафир — это…", a:["свист","твёрдость","отскок"], c:0}]
  },

  {id:"exam2", block:"exam", order:19, title:"Экзамен: Блок 2 (Сыфаты)", tags:["экзамен","сыфаты"], pass:0.7,
   text:`Экзамен по сыфатам. Проходной: 70%.\n\nПодсказка: если ошиблась — вернись к уроку и посмотри схему + примеры.`,
   diagram:{title:"Схема: повторение", steps:[
     {t:"Шидда/Байния/Рахава", d:"поток звука"},
     {t:"Хамс/Джахр", d:"дыхание или удержание"},
     {t:"Истиля/Истифаль", d:"твёрдость"},
     {t:"Итбак/Инфитах", d:"усиление твёрдости"},
     {t:"Калькаля", d:"отскок"}
   ]},
   quiz:[
     {q:"Байния (البينية) — буквы:", a:["ل ن ع م ر","أ ج د ق ط ب ك ت","ف ح ث ه ش خ"], c:0},
     {q:"Буквы хамса:", a:["ف ح ث ه ش خ ص س ك ت","ق ط ب ج د","ص ض ط ظ"], c:0},
     {q:"Буквы исти‘ля:", a:["خ ص ض غ ط ق ظ","ص ض ط ظ","س ص ز"], c:0},
     {q:"Калькаля на:", a:["ق ط ب ج د","س ص ز","ء ه ع"], c:0},
     {q:"Звук “течёт” — это…", a:["Щидда","Рахава","Калькаля"], c:1},
     {q:"Сафир — буквы:", a:["س ص ز","ل ر","و ي"], c:0},
     {q:"Итбак — буквы:", a:["ص ض ط ظ","خ ص ض غ ط ق ظ","ف ح ث ه ش خ"], c:0},
     {q:"Такрир относится к:", a:["ر","س","ق"], c:0},
     {q:"Джахр — это…", a:["дыхание","удержание воздуха","отскок"], c:1},
     {q:"Щидда — буквы:", a:["أ ج د ق ط ب ك ت","ل ن ع م ر","س ص ز"], c:0}
   ]
  },

  
  // -------- Блок 3 (по учебнику, подробно)
  {id:"b3_intro", block:"b3", order:30, title:"Б3-1) Нун ساкина (نْ) и танвин (ً ٍ ٌ): основы", tags:["نْ","танвин","ن ساكنة","تنوين"],
   text:`Нун ساкина (نْ) — буква ن с сукуном.\nТанвин (ً ٍ ٌ) — двойная огласовка на конце слова (как “н” на конце).\n\nКогда نْ или танвин встречаются со следующей буквой, применяется одно из 4 правил:\n1) Изхар (الإظهار)\n2) Идгъам (الإدغام)\n3) Икъляб (الإقلاب)\n4) Ихфа (الإخفاء)\n\nВ учебнике это — ключевая тема. Сначала запомни группы букв, потом тренируй слух.`,
   extras:[
     {type:"callout", title:"Важно", body:"Правило выбирается по БУКВЕ после نْ или танвина."}
   ],
   diagram:{title:"Схема выбора правила", steps:[
     {t:"Следом: ء ه ع ح غ خ", d:"→ Изхар"},
     {t:"Следом: ي ن م و", d:"→ Идгъам с гъунной"},
     {t:"Следом: ل ر", d:"→ Идгъам без гъунны"},
     {t:"Следом: ب", d:"→ Икъляб"},
     {t:"Следом: 15 букв (т ث ج…)", d:"→ Ихфа"}
   ]},
   quiz:[
     {q:"Сколько правил у нун ساкина и танвина?", a:["3","4","5"], c:1},
     {q:"Правило выбирается по…", a:["первой букве слова","букве после نْ/танвина","по знаку вакфа"], c:1}
   ]
  },

  {id:"b3_izhar", block:"b3", order:31, title:"Б3-2) Изхар (الإظهار): ясное чтение", tags:["изхар","الإظهار","гортанные"],
   text:`Изхар (الإظهار) — ясное чтение نْ и танвина.\n\nУсловие: после نْ или танвина идёт одна из гортанных букв:\nء  ه  ع  ح  غ  خ\n\nКак читаем:\n— نْ/танвин произносим ясно (кончик языка у основания верхних передних зубов)\n— гъунны (назализации) как в ихфа/идгаме нет\n\nПодсказки в мусхафе (по учебнику):\n— у نْ обычно виден явный сукун (сукун хафифа)\n— у танвина две огласовки часто стоят “ровно” (без сдвига).`,
   extras:[
     {type:"arabic_examples", title:"Примеры (подсветка — следующая буква)", items:[
       {ar:"مِنْ <span class='hl'>ه</span>َادٍ", note:"После نْ идёт ه → Изхар"},
       {ar:"مِنْ <span class='hl'>ع</span>ِلْمٍ", note:"После نْ идёт ع → Изхар"},
       {ar:"عَلِيمٌ <span class='hl'>خ</span>َبِيرٌ", note:"Танвин + خ → Изхар"}
     ]}
   ],
   diagram:{title:"Изхар: правило", steps:[
     {t:"Если после نْ/танвина", d:"ء ه ع ح غ خ"},
     {t:"→", d:"читаем ясно (изхар)"}
   ]},
   quiz:[{q:"Изхар — буквы:", a:["ء ه ع ح غ خ","ي ن م و","ص ض ط ظ"], c:0}]
  },

  {id:"b3_idgham", block:"b3", order:32, title:"Б3-3) Идгъам (الإدغام): ассимиляция", tags:["идгам","الإدغام","гъунна"],
   text:`Идгъам (الإدغام) — “введение/слияние”: نْ или танвин сливаются со следующей буквой.\n\nВ учебнике идгъам делится на 2 вида:\n\n1) Идгъам би-гъунна (إدغام بغنة) — с носовым звуком (гъунной)\nБуквы: ي ن م و (складываются в слово «يمنو»)\n— при слиянии остаётся часть назализации (гъунна)\n— длительность гъунны примерно 2 счёта\n\n2) Идгъам би-ля гъунна (إدغام بلا غنة) — без гъунны\nБуквы: ل ر\n— слияние без носового оттенка\n\nИсключение (по учебнику):\nЕсли نْ встречается с و или ي ВНУТРИ ОДНОГО СЛОВА, правило идгъама не применяется.\nКлассические слова-исключения: الدنيا، بنيان، قنوان، صنوان.`,
   extras:[
     {type:"arabic_examples", title:"Примеры: идгъам с гъунной (ي ن م و)", items:[
       {ar:"مِنْ <span class='hl'>و</span>َلِيٍّ", note:"نْ + و → идгъам с гъунной"},
       {ar:"مِنْ <span class='hl'>م</span>َالٍ", note:"نْ + م → идгъам с гъунной"},
       {ar:"هُدًى <span class='hl'>ن</span>ُورٍ", note:"танвин + ن → идгъам с гъунной"}
     ]},
     {type:"arabic_examples", title:"Примеры: идгъам без гъунны (ل ر)", items:[
       {ar:"مِنْ <span class='hl'>ر</span>َبِّهِمْ", note:"نْ + ر → идгъам без гъунны"},
       {ar:"هُدًى <span class='hl'>ل</span>ِّلْمُتَّقِينَ", note:"танвин + ل → идгъам без гъунны"}
     ]},
     {type:"callout", title:"Исключения", body:"الدنيا، بنيان، قنوان، صنوان — если نْ + و/ي в одном слове, идгъам не делаем."}
   ],
   diagram:{title:"Идгъам: две ветки", steps:[
     {t:"ي ن م و", d:"с гъунной (2 счёта)"},
     {t:"ل ر", d:"без гъунны"}
   ]},
   quiz:[
     {q:"Идгъам с гъунной — буквы:", a:["ي ن م و","ل ر","ء ه ع ح غ خ"], c:0},
     {q:"Идгъам без гъунны — буквы:", a:["ل ر","ق ط ب ج د","س ص ز"], c:0}
   ]
  },

  {id:"b3_iqlab", block:"b3", order:33, title:"Б3-4) Икъляб (الإقلاب): замена", tags:["икляб","الإقلاب","م"],
   text:`Икъляб (الإقلاب) — замена.\n\nУсловие: после نْ или танвина идёт буква ب.\n\nКак читаем:\n— вместо “н” произносится звук “м” (م) с гъунной\n— длительность гъунны: 2 счёта\n\nПодсказка в мусхафе (по учебнику):\n— над ن или под ней, а также возле танвина ставится маленькая م.\n— иногда вместо двух огласовок танвина оставляют одну и добавляют маленькую م.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"مِنْ <span class='hl'>ب</span>َعْدِ", note:"نْ + ب → икъляб (н→м + гъунна)"},
       {ar:"سَمِيعٌ <span class='hl'>ب</span>َصِيرٌ", note:"танвин + ب → икъляб"}
     ]}
   ],
   diagram:{title:"Икъляб: правило", steps:[
     {t:"Если после نْ/танвина", d:"ب"},
     {t:"→", d:"ن → م + гъунна (2 счёта)"}
   ]},
   quiz:[{q:"Икъляб применяется перед:", a:["ب","ل","خ"], c:0}]
  },

  {id:"b3_ikhfa", block:"b3", order:34, title:"Б3-5) Ихфа (الإخفاء): сокрытие", tags:["ихфа","الإخفاء","15 букв","гъунна"],
   text:`Ихфа (الإخفاء) — сокрытие.\n\nУсловие: после نْ или танвина идёт одна из 15 букв ихфа:\nت ث ج د ذ ز س ش ص ض ط ظ ف ق ك\n\nКак читаем (по учебнику):\n— نْ/танвин не читаются “явно”, кончик языка не прижимается к месту нун\n— нун как бы “скрыт”, но сохраняется гъунна\n— органы речи заранее готовятся к следующей букве так, чтобы по слуху было понятно, КАКАЯ буква из 15 идёт дальше\n\nПодсказки в мусхафе:\n— сукун на нун “скрыт” (сукун ария)\n— у танвина две огласовки стоят со сдвигом.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"مِنْ <span class='hl'>ت</span>َحْتِهَا", note:"نْ + ت → ихфа"},
       {ar:"مِنْ <span class='hl'>ق</span>َبْلُ", note:"нун “уходит” сильнее в нос из‑за заднего махраджа ق (примечание из учебника)"},
       {ar:"عَلِيمٌ <span class='hl'>ش</span>َكُورٌ", note:"танвин + ش → ихфа"}
     ]}
   ],
   diagram:{title:"Ихфа: ключевые ощущения", steps:[
     {t:"15 букв", d:"ت ث ج د ذ ز س ش ص ض ط ظ ف ق ك"},
     {t:"Гъунна", d:"сохраняется"},
     {t:"Язык", d:"не прижимается к нун, готовится к следующей букве"}
   ]},
   quiz:[
     {q:"Сколько букв ихфа?", a:["15","6","10"], c:0},
     {q:"К ихфа относятся:", a:["ت ث ج د ذ ز س ش ص ض ط ظ ف ق ك","ء ه ع ح غ خ","ل ر"], c:0}
   ]
  },

  {id:"exam3", block:"exam", order:35, title:"Экзамен: Блок 3 (Нун ساкина и танвин)", tags:["экзамен","نْ","танвин"], pass:0.7,
   text:`Экзамен по правилам нун ساкина и танвина.\nПроходной: 70%.\n\nПодсказка: главное — запомнить группы букв.`,
   diagram:{title:"Схема: 4 правила", steps:[
     {t:"Изхар", d:"ء ه ع ح غ خ"}
,
  // -------- Блок 4 (по учебнику, подробно)
  {id:"b4_intro", block:"b4", order:40, title:"Б4-1) Мим ساкина (مْ): основы", tags:["مْ","م ساكنة"],
   text:`Мим сакина (مْ) — буква م с сукуном.\n\nКак и нун сакина, мим сакина имеет СТРОГО определённые правила чтения в зависимости от следующей буквы.\n\nВсего 3 правила:\n1) Ихфа шафауи (الإخفاء الشفوي)\n2) Идгъам мислейн (الإدغام المتماثلين)\n3) Изхар шафауи (الإظهار الشفوي)\n\nНазвание «шафауи» (شفوي) указывает на губы (شفاه), т.к. мим образуется губами.`,
   extras:[
     {type:"callout", title:"Запомни", body:"Правило для مْ выбирается по БУКВЕ после неё."}
   ],
   diagram:{title:"Схема выбора правила для مْ", steps:[
     {t:"Если بعده ب", d:"→ Ихфа шафауи"},
     {t:"Если بعده م", d:"→ Идгъам мислейн"},
     {t:"Любая другая буква", d:"→ Изхар шафауи"}
   ]},
   quiz:[
     {q:"Сколько правил у مْ?", a:["2","3","4"], c:1},
     {q:"Правило выбирается по…", a:["букве قبل","букве بعد","знаку вакфа"], c:1}
   ]
  },

  {id:"b4_ikhfa", block:"b4", order:41, title:"Б4-2) Ихфа шафауи (الإخفاء الشفوي)", tags:["ихфа шафауи","شفوي"],
   text:`Ихфа шафауи (الإخفاء الشفوي) — губное сокрытие.\n\nУсловие:\n— мим ساкина (مْ)\n— после неё идёт буква ب\n\nКак читаем (по учебнику):\n— губы не смыкаются полностью\n— звук мим скрыт\n— присутствует гъунна (назализация)\n— длительность гъунны ≈ 2 счёта\n\nВажно:\n— не читать явно «м»\n— не превращать в идгъам`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"تَرْمِ<span class='hl'>ي</span>هِمْ <span class='hl'>ب</span>ِحِجَارَةٍ", note:"مْ + ب → ихфа шафауи"},
       {ar:"كَمْ <span class='hl'>ب</span>َدَا", note:"гъунна с сокрытием мим"}
     ]}
   ],
   diagram:{title:"Ихфа шафауи: ощущения", steps:[
     {t:"Губы", d:"не смыкаются полностью"},
     {t:"Гъунна", d:"2 счёта"},
     {t:"Следующая буква", d:"ب"}
   ]},
   quiz:[{q:"Ихфа шафауи бывает перед:", a:["ب","م","всеми"], c:0}]
  },

  {id:"b4_idgham", block:"b4", order:42, title:"Б4-3) Идгъам мислейн (الإدغام المتماثلين)", tags:["идгам мислейн"],
   text:`Идгъам мислейн (الإدغام المتماثلين) — слияние двух одинаковых букв.\n\nУсловие:\n— мим ساкина (مْ)\n— после неё идёт мим с харакатом (مَ / مُ / مِ)\n\nКак читаем:\n— две мим сливаются в одну\n— обязательно присутствует гъунна\n— длительность гъунны ≈ 2 счёта\n\nЭто правило иногда называют:\n— идгъам шафауи\n— или просто «мим с мим»`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"لَكُ<span class='hl'>مْ م</span>َا", note:"مْ + م → идгъам мислейн"},
       {ar:"هُ<span class='hl'>مْ م</span>ُّؤْمِنُونَ", note:"двойная мим с гъунной"}
     ]}
   ],
   diagram:{title:"Идгъам мислейн", steps:[
     {t:"مْ + م", d:"слияние"},
     {t:"Гъунна", d:"обязательно"},
     {t:"Длительность", d:"2 счёта"}
   ]},
   quiz:[{q:"При идгъам мислейн гъунна…", a:["есть","нет"], c:0}]
  },

  {id:"b4_izhar", block:"b4", order:43, title:"Б4-4) Изхар шафауи (الإظهار الشفوي)", tags:["изхар шафауи"],
   text:`Изхар шафауи (الإظهار الشفوي) — ясное губное чтение.\n\nУсловие:\n— мим ساкина (مْ)\n— после неё ЛЮБАЯ буква, кроме ب и م\n\nКак читаем:\n— мим произносится ясно\n— без гъунны\n— губы полностью смыкаются на мим\n\nВнимание (ошибка учеников):\n— не добавляй гъунну по привычке\n— особенно перед و и ف`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"هُ<span class='hl'>مْ ف</span>ِيهَا", note:"мим читается ясно"},
       {ar:"عَلَيْهِ<span class='hl'>مْ ص</span>َلَوَاتٌ", note:"изхар шафауи"}
     ]}
   ],
   diagram:{title:"Изхар шафауи", steps:[
     {t:"Если после مْ", d:"не ب и не م"},
     {t:"→", d:"ясное чтение"},
     {t:"Гъунна", d:"нет"}
   ]},
   quiz:[{q:"Изхар шафауи — это…", a:["ясное чтение","сокрытие","слияние"], c:0}]
  },

  {id:"exam4", block:"exam", order:44, title:"Экзамен: Блок 4 (Мим ساкина)", tags:["экзамен","مْ"], pass:0.7,
   text:`Экзамен по правилам ميم ساكنة.\nПроходной: 70%.`,
   diagram:{title:"Схема: 3 правила مْ", steps:[
     {t:"مْ + ب", d:"Ихфа шафауи"}
,
  // -------- Блок 5 (по учебнику, подробно)
  {id:"b5_intro", block:"b5", order:50, title:"Б5-1) Мадд (المد): что это", tags:["мадд","المد"],
   text:`Мадд (المد) — это удлинение звука.\n\nВ таджвиде мадд связан с буквами:\nا  و  ي\n\nЧтобы мадд был, нужно:\n1) буква мадда\n2) перед ней подходящая огласовка\n\nДлина мадда измеряется в харакатах (счётах).`,
   diagram:{title:"Схема: когда есть мадд", steps:[
     {t:"ا после фатхи", d:"→ мадд"},
     {t:"و после даммы", d:"→ мадд"},
     {t:"ي после касры", d:"→ мадд"}
   ]},
   quiz:[{q:"Буквы мадда:", a:["ا و ي","ق ط ب ج د","ء ه ع"], c:0}]
  },

  {id:"b5_tabii", block:"b5", order:51, title:"Б5-2) Мадд табии (المد الطبيعي)", tags:["мадд табии"],
   text:`Мадд табии — естественный мадд.\n\nДлительность: 2 хараката.\n\nОн есть всегда, если:\n— нет хамзы\n— нет сукуна\nпосле буквы мадда.\n\nЭто основа всех видов мадда.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"قَ<span class='hl'>ا</span>لَ", note:"ا после фатхи → 2 счёта"},
       {ar:"يَقُ<span class='hl'>و</span>لُ", note:"و после даммы → 2 счёта"},
       {ar:"قِ<span class='hl'>ي</span>لَ", note:"ي после касры → 2 счёта"}
     ]}
   ],
   diagram:{title:"Мадд табии", steps:[
     {t:"Нет хамзы", d:"и нет сукуна"},
     {t:"→", d:"2 хараката"}
   ]},
   quiz:[{q:"Мадд табии тянется:", a:["2","4","6"], c:0}]
  },

  {id:"b5_wajib", block:"b5", order:52, title:"Б5-3) Мадд ваджиб муттасыль (المد الواجب المتصل)", tags:["мадд ваджиб","متصل"],
   text:`Мадд ваджиб муттасыль — обязательный связанный мадд.\n\nУсловие:\n— буква мадда\n— сразу после неё хамза\n— в одном слове\n\nДлительность:\n4–5 харакатов (по учебнику).`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"جَ<span class='hl'>اء</span>َ", note:"ا + ء в одном слове"},
       {ar:"سُ<span class='hl'>وء</span>ُ", note:"و + ء → ваджиб"}
     ]}
   ],
   diagram:{title:"Ваджиб муттасыль", steps:[
     {t:"Буква мадда", d:""},
     {t:"Хамза после", d:"в том же слове"},
     {t:"→", d:"4–5 харакатов"}
   ]},
   quiz:[{q:"Ваджиб муттасыль — это:", a:["мадд + хамза в одном слове","мадд + сукун","мадд без причины"], c:0}]
  },

  {id:"b5_jaiz", block:"b5", order:53, title:"Б5-4) Мадд джаиз мунфасыль (المد الجائز المنفصل)", tags:["мадд джаиз","منفصل"],
   text:`Мадд джаиз мунфасыль — допустимый раздельный мадд.\n\nУсловие:\n— буква мадда\n— хамза в СЛЕДУЮЩЕМ слове\n\nДлительность:\n2, 4 или 5 харакатов (по учебнику).`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"بِمَ<span class='hl'>ا</span> <span class='hl'>أ</span>ُنزِلَ", note:"мадд в конце слова + хамза в следующем"},
       {ar:"فِ<span class='hl'>ي</span> <span class='hl'>أ</span>َنفُسِكُمْ", note:"я + хамза раздельно"}
     ]}
   ],
   diagram:{title:"Джаиз мунфасыль", steps:[
     {t:"Мадд", d:"в конце слова"},
     {t:"Хамза", d:"в следующем слове"},
     {t:"→", d:"2 / 4 / 5"}
   ]},
   quiz:[{q:"Джаиз мунфасыль тянется:", a:["2/4/5","4/6","2"], c:0}]
  },

  {id:"b5_lazim", block:"b5", order:54, title:"Б5-5) Мадд лязим (المد اللازم)", tags:["мадд лязим"],
   text:`Мадд лязим — обязательный длинный мадд.\n\nУсловие:\n— буква мадда\n— после неё СУКУН\n— сукун постоянный (в слове или по шадде)\n\nДлительность:\n6 харакатов.`,
   extras:[
     {type:"arabic_examples", title:"Примеры", items:[
       {ar:"الضَّ<span class='hl'>ا</span>ٓلِّينَ", note:"шадда = сукун → 6 счётов"},
       {ar:"ءَا<span class='hl'>ل</span>ٓـٰنَ", note:"лязим в слове"}
     ]}
   ],
   diagram:{title:"Мадд лязим", steps:[
     {t:"Мадд", d:""},
     {t:"Сукун постоянный", d:""},
     {t:"→", d:"6 харакатов"}
   ]},
   quiz:[{q:"Мадд лязим тянется:", a:["6","4","2"], c:0}]
  },

  {id:"b5_arid", block:"b5", order:55, title:"Б5-6) Мадд аарид ли-с-суккун (المد العارض للسكون)", tags:["мадд аарид"],
   text:`Мадд аарид ли-с-суккун — мадд из-за остановки.\n\nУсловие:\n— мадд табии\n— в конце слова\n— при вакфе появляется временный сукун\n\nДлительность:\n2, 4 или 6 харакатов.`,
   extras:[
     {type:"arabic_examples", title:"Примеры (при остановке)", items:[
       {ar:"الْعَالَمِ<span class='hl'>ينْ</span>", note:"остановка → временный сукун"},
       {ar:"الرَّحِ<span class='hl'>يمْ</span>", note:"мадд удлиняется при вакфе"}
     ]}
   ],
   diagram:{title:"Аарид ли-с-суккун", steps:[
     {t:"Вакф", d:"остановка"},
     {t:"Сукун временный", d:""},
     {t:"→", d:"2 / 4 / 6"}
   ]},
   quiz:[{q:"Аарид ли-с-суккун — при:", a:["остановке","соединении","шадде"], c:0}]
  },

  {id:"exam5", block:"exam", order:56, title:"Экзамен: Блок 5 (Мадды)", tags:["экзамен","мадд"], pass:0.7,
   text:`Экзамен по видам мадда.\nПроходной: 70%.`,
   diagram:{title:"Схема: виды мадда", steps:[
     {t:"Табии", d:"2"}
,
  // -------- Блок 6 (по учебнику, подробно)
  {id:"b6_intro", block:"b6", order:60, title:"Б6-1) Вакф и ибтида: основы", tags:["вакф","ибтида","وقف","ابتداء"],
   text:`Вакф (وقف) — остановка при чтении.\nИбтида (ابتداء) — начало чтения.\n\nПравильный вакф и ибтида:\n— сохраняют смысл аята\n— не искажают значение\n— делают чтение красивым и понятным\n\nНеправильная остановка может ИЗМЕНИТЬ смысл.`,
   extras:[
     {type:"callout", title:"Важно", body:"Вакф и ибтида — не просто паузы, а смысловое правило."}
   ],
   diagram:{title:"Связь вакф и ибтида", steps:[
     {t:"Вакф", d:"где остановиться"},
     {t:"Ибтида", d:"как правильно начать"},
     {t:"→", d:"сохранение смысла"}
   ]},
   quiz:[
     {q:"Вакф — это…", a:["остановка","удлинение","слияние"], c:0},
     {q:"Ибтида — это…", a:["начало","остановка","мадд"], c:0}
   ]
  },

  {id:"b6_types", block:"b6", order:61, title:"Б6-2) Виды вакфа", tags:["вакф","تام","كاف","حسن","قبيح"],
   text:`В учебнике вакф делится на 4 вида:\n\n1) Вакф таам (تام) — полный\n2) Вакф кафий (كاف) — достаточный\n3) Вакф хасан (حسن) — хороший\n4) Вакф къабих (قبيح) — плохой\n\nКлассификация основана на СМЫСЛЕ.`,
   extras:[
     {type:"callout", title:"Запомни", body:"Чем сильнее завершён смысл — тем «лучше» вакф."}
   ],
   diagram:{title:"Виды вакфа", steps:[
     {t:"تام", d:"смысл завершён полностью"},
     {t:"كاف", d:"смысл завершён, но связан"},
     {t:"حسن", d:"остановка допустима"},
     {t:"قبيح", d:"останавливаться нельзя"}
   ]},
   quiz:[{q:"Сколько видов вакфа?", a:["4","3","5"], c:0}]
  },

  {id:"b6_tam", block:"b6", order:62, title:"Б6-3) Вакф таам (تام)", tags:["تام","полный"],
   text:`Вакф таам — полная, завершённая остановка.\n\nПризнаки:\n— смысл аята завершён\n— следующая часть не связана грамматически\n\nЭто ЛУЧШИЙ вид вакфа.`,
   extras:[
     {type:"arabic_examples", title:"Пример", items:[
       {ar:"وَأُولَٰئِكَ هُمُ الْمُفْلِحُ<span class='hl'>ونَ</span>", note:"Смысл завершён полностью"}
     ]}
   ],
   quiz:[{q:"Вакф таам — это:", a:["лучший вакф","запрещённый","вынужденный"], c:0}]
  },

  {id:"b6_kafi", block:"b6", order:63, title:"Б6-4) Вакф кафий (كاف)", tags:["كاف","достаточный"],
   text:`Вакф кафий — достаточный вакф.\n\nПризнаки:\n— смысл завершён\n— но есть связь со следующим\n\nОстановка допустима.`,
   extras:[
     {type:"arabic_examples", title:"Пример", items:[
       {ar:"ذَٰلِكَ الْكِتَابُ لَا رَيْبَ <span class='hl'>فِيهِ</span>", note:"Смысл ясен, но тема продолжается"}
     ]}
   ],
   quiz:[{q:"Кафий — это вакф:", a:["достаточный","плохой","запрещённый"], c:0}]
  },

  {id:"b6_hasan", block:"b6", order:64, title:"Б6-5) Вакф хасан (حسن)", tags:["حسن","хороший"],
   text:`Вакф хасан — хороший вакф.\n\nПризнаки:\n— смысл частично завершён\n— но продолжение связано грамматически\n\nПри ибтида НЕЛЬЗЯ начинать со следующего слова.`,
   extras:[
     {type:"arabic_examples", title:"Пример", items:[
       {ar:"الْحَمْدُ لِلَّهِ <span class='hl'>رَبِّ</span>", note:"Остановка допустима, но начинать с «رَبِّ» нельзя"}
     ]}
   ],
   quiz:[{q:"После вакф хасан можно начинать:", a:["с предыдущего слова","со следующего","как угодно"], c:0}]
  },

  {id:"b6_qabih", block:"b6", order:65, title:"Б6-6) Вакф къабих (قبيح)", tags:["قبيح","плохой"],
   text:`Вакф къабих — плохой вакф.\n\nПризнаки:\n— искажается смысл\n— нарушается грамматика\n\nТакой вакф ЗАПРЕЩЁН, кроме вынужденной остановки.`,
   extras:[
     {type:"arabic_examples", title:"Пример", items:[
       {ar:"إِنَّمَا يَخْشَى اللَّهَ <span class='hl'>مِنْ</span>", note:"Остановка искажает смысл"}
     ]}
   ],
   quiz:[{q:"Вакф къабих —", a:["запрещён","желателен","обязателен"], c:0}]
  },

  {id:"b6_signs", block:"b6", order:66, title:"Б6-7) Знаки вакфа в мусхафе", tags:["знаки вакфа","م","لا","ج"],
   text:`Основные знаки вакфа:\n\nم — обязательная остановка\nلا — нельзя останавливаться\nج — можно остановиться\nقلى — лучше остановиться\nصلى — лучше продолжить\n\nОни помогают выбрать правильный вакф.`,
   extras:[
     {type:"callout", title:"Совет", body:"Следуй знакам вакфа, если не уверен в смысле."}
   ],
   diagram:{title:"Знаки вакфа", steps:[
     {t:"م", d:"обязательно стоп"},
     {t:"لا", d:"нельзя стоп"},
     {t:"ج", d:"можно"},
     {t:"قلى", d:"лучше стоп"},
     {t:"صلى", d:"лучше продолжить"}
   ]},
   quiz:[{q:"Знак لا означает:", a:["нельзя остановиться","обязательно","можно"], c:0}]
  },

  {id:"exam6", block:"exam", order:67, title:"Экзамен: Блок 6 (Вакф и ибтида)", tags:["экзамен","вакф"], pass:0.7,
   text:`Экзамен по вакфу и ибтида.\nПроходной: 70%.`,
   diagram:{title:"Итог по вакфу", steps:[
     {t:"تام", d:"лучший"},
     {t:"كاف", d:"достаточный"},
     {t:"حسن", d:"допустимый"},
     {t:"قبيح", d:"запрещённый"}
   ]},
   quiz:[
     {q:"Лучший вакф:", a:["تام","كاف","حسن"], c:0},
     {q:"Запрещённый вакф:", a:["قبيح","حسن","كاف"], c:0},
     {q:"Знак م означает:", a:["обязательная остановка","нельзя","можно"], c:0},
     {q:"Знак لا означает:", a:["нельзя остановиться","обязательно","можно"], c:0},
     {q:"Классификация вакфа основана на:", a:["смысле","длине","звуке"], c:0},
     {q:"Ибтида — это:", a:["начало","остановка","удлинение"], c:0},
     {q:"После вакф хасан начинать со следующего слова:", a:["нельзя","можно","обязательно"], c:0},
     {q:"Вакф кафий —", a:["достаточный","плохой","запрещённый"], c:0},
     {q:"При вынужденной остановке на قبيح:", a:["разрешено","запрещено","обязательно"], c:0},
     {q:"Знаки вакфа нужны для:", a:["помощи в чтении","удлинения","слияния"], c:0}
   ]
  }
,
     {t:"Ваджиб", d:"4–5"},
     {t:"Джаиз", d:"2/4/5"},
     {t:"Лязим", d:"6"},
     {t:"Аарид", d:"2/4/6"}
   ]},
   quiz:[
     {q:"Мадд табии:", a:["2","4","6"], c:0},
     {q:"Ваджиб муттасыль —", a:["мадд + хамза в одном слове","мадд + сукун","мадд без причины"], c:0},
     {q:"Джаиз мунфасыль —", a:["хамза в следующем слове","шадда","сукун"], c:0},
     {q:"Лязим тянется:", a:["6","4","2"], c:0},
     {q:"Аарид бывает при:", a:["вакфе","васле","шадде"], c:0},
     {q:"Буквы мадда:", a:["ا و ي","ق ط ب ج د","ء ه ع"], c:0},
     {q:"Джаиз может быть:", a:["2/4/5","6","2"], c:0},
     {q:"Ваджиб — длительность:", a:["4–5","2","6"], c:0},
     {q:"Аарид — длительность:", a:["2/4/6","4","6"], c:0},
     {q:"Мадд связан с:", a:["удлинением","сокрытием","слиянием"], c:0}
   ]
  }
,
     {t:"مْ + م", d:"Идгъам мислейн"},
     {t:"Иначе", d:"Изхар шафауи"}
   ]},
   quiz:[
     {q:"Мْ + ب →", a:["ихфа шафауи","идгъам мислейн","изхар"], c:0},
     {q:"Мْ + م →", a:["идгъам мислейн","изхар","ихфа"], c:0},
     {q:"Мْ + ف →", a:["изхар шафауи","ихфа","идгъам"], c:0},
     {q:"При идгъам мислейн гъунна:", a:["есть","нет"], c:0},
     {q:"Сколько правил у مْ?", a:["3","4","2"], c:0},
     {q:"Ихфа шафауи — губное…", a:["сокрытие","слияние","удлинение"], c:0},
     {q:"Изхар шафауи — гъунна:", a:["нет","есть"], c:0},
     {q:"Название «шафауи» связано с:", a:["языком","гортанью","губами"], c:2},
     {q:"Мим образуется:", a:["языком","губами","гортанью"], c:1},
     {q:"Мْ + ص →", a:["изхар шафауи","ихфа","идгъам"], c:0}
   ]
  }
,
     {t:"Идгъам", d:"ي ن م و (с гъунной), ل ر (без)"},
     {t:"Икъляб", d:"ب"},
     {t:"Ихфа", d:"15 букв: ت ث ج د ذ ز س ش ص ض ط ظ ف ق ك"}
   ]},
   quiz:[
     {q:"Изхар — буквы:", a:["ء ه ع ح غ خ","ت ث ج د ذ","ي ن م و"], c:0},
     {q:"Икъляб — перед:", a:["ب","ر","خ"], c:0},
     {q:"Идгъам с гъунной — буквы:", a:["ي ن م و","ل ر","ص ض ط ظ"], c:0},
     {q:"Идгъам без гъунны — буквы:", a:["ل ر","ء ه ع ح غ خ","ق ط ب ج د"], c:0},
     {q:"Ихфа — сколько букв?", a:["15","6","4"], c:0},
     {q:"Танвин — это:", a:["ن с сукуном","двойная огласовка (ً ٍ ٌ)","знак вакфа"], c:1},
     {q:"نْ + ه →", a:["изхар","ихфа","икъляб"], c:0},
     {q:"نْ + م →", a:["идгъам с гъунной","идгъам без гъунны","изхар"], c:0},
     {q:"نْ + ر →", a:["идгъам без гъунны","ихфа","икъляб"], c:0},
     {q:"نْ + ت →", a:["ихфа","изхар","икъляб"], c:0}
   ]
  },

  // -------- Остальные блоки (пока компактно — обновим так же “по учебнику”)
  {id:"mim1", block:"b4", order:40, title:"Б4-1) Мим ساкина — 3 правила", tags:["مْ"],
   text:`Мим сакина (مْ) имеет 3 правила:\n— Ихфа шафауи (перед ب)\n— Идгам мислейн (перед م)\n— Изхар шафауи (иначе)`,
   quiz:[{q:"Сколько правил у мим ساкина?",a:["3","4","2"],c:0}]
  },
  {id:"md1", block:"b5", order:50, title:"Б5-1) Мадд — основы", tags:["мадд","ا و ي"],
   text:`Мадд — протяжение звука. Буквы мадда: ا و ي.\n\nВиды: табии, ваджиб, джаиз, лязим, арид.`,
   quiz:[{q:"Буквы мадда:",a:["ا و ي","ق ط ب","ء ه ع"],c:0}]
  },
  {id:"w1", block:"b6", order:60, title:"Б6-1) Вакф и ибтида — основы", tags:["вакф","ибтида"],
   text:`Вакф — остановка. Ибтида — начало.\n\nЗнаки: م (стоп), لا (нельзя), ج (можно), قلى (лучше стоп), صلى (лучше продолжить).`,
   quiz:[{q:"Знак لا означает…",a:["можно","нельзя","обязательно"],c:1}]
  },

  // -------- Тренажёр + итоговый экзамен
  {id:"trainer", block:"trainer", order:90, title:"🎯 Тренажёр: угадай правило", tags:["тренажёр"], trainer:true,
   text:`Тренажёр для закрепления (вопросы идут по кругу).`
  },
  {id:"final", block:"exam", order:99, title:"🏁 Итоговый экзамен (все блоки)", tags:["экзамен","итог"], pass:0.7,
   text:`Итоговый экзамен. Проходной: 70%.`,
   quiz:[
     {q:"Буквы хамса:", a:["ف ح ث ه ش خ ص س ك ت","ق ط ب ج د","ص ض ط ظ"], c:0},
     {q:"Калькаля на:", a:["ق ط ب ج د","س ص ز","ء ه ع"], c:0},
     {q:"Буквы исти‘ля:", a:["خ ص ض غ ط ق ظ","س ص ز","أ ج د"], c:0},
     {q:"نْ + ب →", a:["изхар","икъляб","ихфа"], c:1},
     {q:"نْ + ه →", a:["изхар","ихфа","икъляб"], c:0},
     {q:"نْ + م →", a:["идгъам с гъунной","идгъам без гъунны","изхар"], c:0},
     {q:"Идгъам без гъунны —", a:["ل ر","ي ن م و","ء ه ع ح غ خ"], c:0},
     {q:"Знак لا —", a:["можно","нельзя","обязательно"], c:1},
     {q:"Мадд табии тянется:", a:["2","4","6"], c:0},
     {q:"مْ + م →", a:["идгам мислейн","ихфа","изхар"], c:0}
   ]
  }

];

// ==========================
// State
// ==========================
const LS_DONE="tajweed_done_v18";
const LS_EXAM="tajweed_exams_v18";
const LS_SETTINGS="tajweed_settings_v18";
const done=new Set(JSON.parse(localStorage.getItem(LS_DONE)||"[]"));
const exams=JSON.parse(localStorage.getItem(LS_EXAM)||"{}");
let settings=JSON.parse(localStorage.getItem(LS_SETTINGS)||"{}");

const el=id=>document.getElementById(id);
function blockLabel(b){
  return ({
    b1:"Блок 1: Махраджи",
    b2:"Блок 2: Сыфаты",
    b3:"Блок 3: Нун ساкина",
    b4:"Блок 4: Мим ساкина",
    b5:"Блок 5: Мадды",
    b6:"Блок 6: Вакф и ибтида",
    trainer:"Тренажёр",
    exam:"Экзамены"
  })[b]||"Урок";
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function examBadge(id){
  const e=exams[id];
  if(!e) return "📝";
  return e.passed ? `<span class="good">🏁 ${Math.round(e.score*100)}%</span>` : `<span class="bad">📝 ${Math.round(e.score*100)}%</span>`;
}

// sorted list for navigation
const ordered = [...lessons].sort((a,b)=>(a.order||0)-(b.order||0));

// ==========================
// Render list
// ==========================
function render(){
  el("progressPill").textContent=`${done.size}/${lessons.length}`;

  const q=(el("q").value||"").trim().toLowerCase();
  const bf=el("blockFilter").value;

  const filtered = ordered.filter(l=>{
    if(bf!=="all"){
      if(bf==="exam"){ if(l.block!=="exam") return false; }
      else if(bf==="trainer"){ if(l.block!=="trainer") return false; }
      else if(l.block!==bf) return false;
    }
    if(!q) return true;
    const hay=(l.title+" "+(l.tags||[]).join(" ")+" "+(l.text||"")).toLowerCase();
    return hay.includes(q);
  });

  el("lessonList").innerHTML = filtered.map(l=>{
    const isExam = l.block==="exam";
    const isTrainer = l.block==="trainer";
    const badge = isExam ? examBadge(l.id) : (isTrainer ? "🎯" : (done.has(l.id) ? "✅" : "⬜"));
    return `
      <div class="card" style="margin:0;">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:900">${escapeHtml(l.title)} ${badge}</div>
            <div class="muted small">${escapeHtml(blockLabel(l.block))}</div>
          </div>
          <button class="primary" onclick="openLesson('${l.id}')">Открыть</button>
        </div>
      </div>
    `;
  }).join("");
}

// ==========================
// Lesson view
// ==========================
let currentId=null;

function openLesson(id){
  const idx = ordered.findIndex(x=>x.id===id);
  if(idx<0) return;
  currentId=id;

  const l=ordered[idx];
  el("viewHome").style.display="none";
  el("viewLesson").style.display="block";

  el("lessonTitle").textContent=l.title;
  el("lessonText").textContent=l.text||"";
  el("lessonBadges").innerHTML =
    `<span class="tag">${escapeHtml(blockLabel(l.block))}</span>` +
    (l.tags||[]).slice(0,10).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join(" ");

  // prev/next
  const prev = idx>0 ? ordered[idx-1].id : null;
  const next = idx<ordered.length-1 ? ordered[idx+1].id : null;
  el("prevBtn").disabled = !prev;
  el("nextBtn").disabled = !next;
  el("prevBtn").onclick = ()=> prev && openLesson(prev);
  el("nextBtn").onclick = ()=> next && openLesson(next);

  // extras
  renderExtras(l.extras||[]);

  // diagram
  renderDiagram(l.diagram);

  // action button + quiz/trainer/exam
  const btn=el("btnDone");
  if(l.block==="exam"){
    const e=exams[id];
    btn.textContent = e?.passed ? `Экзамен сдан (${Math.round(e.score*100)}%)` : (e ? `Пересдать (последний ${Math.round(e.score*100)}%)` : "Начать экзамен");
    btn.onclick=()=>startExam(l);
    el("quizBlock").style.display="none"; el("quizBlock").innerHTML="";
  } else if(l.block==="trainer" || l.trainer){
    btn.textContent="Запустить тренажёр";
    btn.onclick=()=>renderTrainer();
    el("quizBlock").style.display="none"; el("quizBlock").innerHTML="";
  } else {
    btn.textContent = done.has(id) ? "Снять «пройдено»" : "Отметить «пройдено»";
    btn.onclick=()=>{
      if(done.has(id)) done.delete(id); else done.add(id);
      localStorage.setItem(LS_DONE, JSON.stringify([...done]));
      openLesson(id);
      render();
    };
    renderQuiz(l.quiz||[], {mode:"mini"});
  }
}

function renderExtras(extras){
  const host = el("lessonExtras");
  host.innerHTML="";
  if(!extras.length) return;
  extras.forEach(x=>{
    if(x.type==="callout"){
      host.innerHTML += `<div class="notice"><b>${escapeHtml(x.title||"Важно")}</b><br/>${escapeHtml(x.body||"")}</div>`;
    }
    if(x.type==="arabic_examples"){
      const items=(x.items||[]).map(it=>`
        <div class="arline">
          <div class="ar">${it.ar}</div>
          <div class="muted small">${escapeHtml(it.note||"")}</div>
        </div>
      `).join("");
      host.innerHTML += `<div class="hr"></div><h3>${escapeHtml(x.title||"Примеры")}</h3>${items}`;
    }
  });
}

// ==========================
// Diagram
// ==========================
function renderDiagram(d){
  const t=el("lessonDiagram");
  if(!d){ t.innerHTML=""; return; }
  const steps=(d.steps||[]).map((s,i)=>`
    <div class="box">
      <div style="font-weight:900">${escapeHtml(s.t)}</div>
      <div class="muted small">${escapeHtml(s.d||"")}</div>
    </div>
    ${i<d.steps.length-1?`<div class="arrow">➜</div>`:""}
  `).join("");
  t.innerHTML = `
    <div class="diagram">
      <div class="title">${escapeHtml(d.title||"Схема")}</div>
      <div class="flow">${steps}</div>
    </div>
  `;
}

// ==========================
// Quiz Engine
// ==========================
function renderQuiz(qs, opts){
  const qb=el("quizBlock");
  if(!qs.length){ qb.style.display="none"; qb.innerHTML=""; return; }
  qb.style.display="block";

  qb.innerHTML = `
    <h3>${opts?.mode==="exam" ? "Экзамен" : "Мини‑тест"}</h3>
    <div class="muted small">${opts?.mode==="exam" ? "Выбери ответы и нажми «Проверить и завершить»." : "Проверь себя прямо сейчас."}</div>
    <div class="hr"></div>
    <div id="qs"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="primary" id="checkBtn">${opts?.mode==="exam" ? "Проверить и завершить" : "Проверить"}</button>
      <button class="ghost" id="resetBtn">Сбросить</button>
      <span class="right"></span>
      <span class="pill" id="scorePill" style="display:none"></span>
    </div>
    <div id="note" style="margin-top:10px;"></div>
  `;

  const qsEl=document.getElementById("qs");
  qsEl.innerHTML = qs.map((x,idx)=>`
    <div class="q">
      <div style="font-weight:900">${escapeHtml(x.q)}</div>
      ${(x.a||[]).map((v,j)=>`
        <label class="opt">
          <input type="radio" name="q${idx}" value="${j}"/>
          <span>${escapeHtml(v)}</span>
        </label>
      `).join("")}
      <div class="muted small" id="fb${idx}"></div>
    </div>
  `).join("");

  const scorePill=document.getElementById("scorePill");
  document.getElementById("resetBtn").onclick=()=>{
    qs.forEach((_,idx)=>{
      document.querySelectorAll(`input[name="q${idx}"]`).forEach(r=>r.checked=false);
      const fb=document.getElementById(`fb${idx}`);
      fb.textContent=""; fb.className="muted small";
    });
    scorePill.style.display="none";
    document.getElementById("note").innerHTML="";
  };

  document.getElementById("checkBtn").onclick=()=>{
    let correct=0;
    qs.forEach((x,idx)=>{
      const sel=document.querySelector(`input[name="q${idx}"]:checked`);
      const fb=document.getElementById(`fb${idx}`);
      if(!sel){
        fb.textContent="Ответ не выбран.";
        fb.className="muted small";
        return;
      }
      const choice=parseInt(sel.value,10);
      if(choice===x.c){
        correct++;
        fb.textContent="Верно ✅";
        fb.className="muted small good";
      } else {
        fb.textContent=`Неверно ❌ (правильный: ${escapeHtml(x.a[x.c])})`;
        fb.className="muted small bad";
      }
    });

    const score=correct/qs.length;
    scorePill.style.display="inline-block";
    scorePill.textContent=`Результат: ${correct}/${qs.length} (${Math.round(score*100)}%)`;

    if(opts?.mode==="exam"){
      opts.onFinish?.(score);
    }
  };
}

function startExam(lesson){
  const pass=typeof lesson.pass==="number" ? lesson.pass : 0.7;
  renderQuiz(lesson.quiz||[], {
    mode:"exam",
    onFinish:(score)=>{
      const passed=score>=pass;
      exams[lesson.id]={score, passed, ts: Date.now()};
      localStorage.setItem(LS_EXAM, JSON.stringify(exams));
      const note=document.getElementById("note");
      note.innerHTML = passed
        ? `<div class="notice good"><b>Экзамен сдан ✅</b><br/>${Math.round(score*100)}% (проходной ${Math.round(pass*100)}%).</div>`
        : `<div class="notice bad"><b>Пока не сдан ❌</b><br/>${Math.round(score*100)}% (нужно ${Math.round(pass*100)}%).</div>`;
      render();
    }
  });
}

// ==========================
// Trainer (mix of topics; will expand later per textbook)
// ==========================
function renderTrainer(){
  const qb=el("quizBlock");
  qb.style.display="block";
  qb.innerHTML = `
    <h3>🎯 Тренажёр</h3>
    <div class="muted small">Выбирай правильное правило. Можно тренироваться бесконечно.</div>
    <div class="hr"></div>
    <div class="q">
      <div class="muted small">Ситуация</div>
      <div style="font-weight:900;font-size:18px" id="tPrompt"></div>
      <div class="hr"></div>
      <div class="muted small">Выбери ответ</div>
      <div id="tOptions"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="primary" id="tCheck">Проверить</button>
        <button class="ghost" id="tNext">Следующий</button>
        <span class="right"></span>
        <span class="pill" id="tScore">0 верно</span>
      </div>
      <div id="tFeedback" class="muted small" style="margin-top:10px"></div>
    </div>
  `;

  const tasks = [
    {p:"Щидда/Байния/Рахава: буквы ل ن ع م ر", ok:"Байния", opts:["Щидда","Байния","Рахава"]},
    {p:"Хамс: ف ح ث ه ش خ ص س ك ت", ok:"Хамс", opts:["Джахр","Хамс","Калькаля"]},
    {p:"Исти‘ля: خ ص ض غ ط ق ظ", ok:"Исти‘ля", opts:["Истифаль","Итбак","Исти‘ля"]},
    {p:"Калькаля: ق ط ب ج د", ok:"Калькаля", opts:["Сафир","Калькаля","Лейн"]},
    {p:"مْ + م", ok:"Идгам мислейн", opts:["Ихфа шафауи","Идгам мислейн","Изхар"]},
    {p:"نْ + ب", ok:"Икляб", opts:["Изхар","Икляб","Ихфа"]},
    {p:"Знак вакфа لا", ok:"Нельзя останавливаться", opts:["Можно","Нельзя останавливаться","Обязательно"]},
    {p:"Мадд табии", ok:"2 хараката", opts:["2 хараката","4–5","6"]},
  ];

  let i = Math.floor(Math.random()*tasks.length);
  let correctCount = 0;

  const promptEl=document.getElementById("tPrompt");
  const optsEl=document.getElementById("tOptions");
  const fbEl=document.getElementById("tFeedback");
  const scoreEl=document.getElementById("tScore");

  function show(){
    fbEl.textContent="";
    const t=tasks[i];
    promptEl.textContent=t.p;
    optsEl.innerHTML = t.opts.map((o,idx)=>`
      <label class="opt">
        <input type="radio" name="tr" value="${idx}"/>
        <span>${escapeHtml(o)}</span>
      </label>
    `).join("");
  }

  function next(){
    i = (i+1) % tasks.length;
    show();
  }

  document.getElementById("tCheck").onclick=()=>{
    const t=tasks[i];
    const sel=document.querySelector('input[name="tr"]:checked');
    if(!sel){ fbEl.textContent="Выбери вариант 🙂"; return; }
    const choice=t.opts[parseInt(sel.value,10)];
    if(choice===t.ok){
      correctCount++;
      fbEl.innerHTML=`<span class="good">Верно ✅</span>`;
      scoreEl.textContent=`${correctCount} верно`;
    } else {
      fbEl.innerHTML=`<span class="bad">Неверно ❌</span> Правильно: <b>${escapeHtml(t.ok)}</b>`;
    }
  };
  document.getElementById("tNext").onclick=()=>next();

  show();
}

// ==========================
// Navigation
// ==========================
function goHome(){
  el("viewLesson").style.display="none";
  el("viewHome").style.display="block";
  render();
}

// keyboard: ←/→ for prev/next
window.addEventListener("keydown",(e)=>{
  if(el("viewLesson").style.display==="none") return;
  if(e.key==="ArrowLeft" && !el("prevBtn").disabled) el("prevBtn").click();
  if(e.key==="ArrowRight" && !el("nextBtn").disabled) el("nextBtn").click();
});

// ==========================
// Settings
// ==========================
function applySettings(){
  const fs=settings.fs ?? 16;
  const ar=settings.ar ?? 1.25;
  const font=settings.arFont ?? `"Amiri","Scheherazade New","Noto Naskh Arabic","Noto Sans Arabic","Arial"`;
  document.documentElement.style.setProperty("--fs", fs+"px");
  document.documentElement.style.setProperty("--arabic-size", ar+"em");
  document.documentElement.style.setProperty("--arabic-font", font);

  // sync UI if exists
  const fsR=document.getElementById("fsRange"); if(fsR) fsR.value=fs;
  const arR=document.getElementById("arRange"); if(arR) arR.value=ar;
  const fsV=document.getElementById("fsVal"); if(fsV) fsV.textContent=fs;
  const arV=document.getElementById("arVal"); if(arV) arV.textContent=ar.toFixed(2)+"em";
  const sel=document.getElementById("arFontSel"); if(sel) sel.value=font;
  localStorage.setItem(LS_SETTINGS, JSON.stringify(settings));
}
applySettings();

const drawer=el("settingsDrawer");
el("settingsBtn").onclick=()=>drawer.classList.add("open");
el("closeSettings").onclick=()=>drawer.classList.remove("open");

el("fsRange").addEventListener("input",(e)=>{settings.fs=parseInt(e.target.value,10); applySettings();});
el("arRange").addEventListener("input",(e)=>{settings.ar=parseFloat(e.target.value); applySettings();});
el("arFontSel").addEventListener("change",(e)=>{settings.arFont=e.target.value; applySettings();});
el("resetSettings").onclick=()=>{settings={}; applySettings();};

// ==========================
// Initial render + PWA
// ==========================
el("q").addEventListener("input",render);
el("blockFilter").addEventListener("change",render);
render();

let dp=null;
window.addEventListener("beforeinstallprompt",e=>{e.preventDefault();dp=e;el("installBtn").style.display="inline-block"});
el("installBtn").onclick=async()=>{if(!dp)return;dp.prompt();await dp.userChoice;dp=null;el("installBtn").style.display="none"};
if("serviceWorker" in navigator){navigator.serviceWorker.register("./sw.js")}
</script>
</body>
</html>
